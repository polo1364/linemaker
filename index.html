<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LINEè²¼åœ–è£½ä½œå·¥å…· - AIæ™ºèƒ½ç”Ÿæˆ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #8b5cf6;
      --primary-dark: #7c3aed;
      --secondary: #ec4899;
      --accent: #06b6d4;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.15);
      --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.2);
      --shadow-glow: 0 0 30px rgba(139, 92, 246, 0.3);
    }

    body {
      font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      background-attachment: fixed;
      min-height: 100vh;
      color: #1f2937;
      overflow-x: hidden;
    }

    /* Animated background particles */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 50%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(236, 72, 153, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(6, 182, 212, 0.1) 0%, transparent 50%);
      animation: float 20s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-20px) scale(1.05); }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 1;
    }

    /* Header */
    header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: 30px 40px;
      border-radius: 24px;
      margin-bottom: 30px;
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(255, 255, 255, 0.3);
      position: relative;
      overflow: hidden;
    }

    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.1), transparent);
      animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    h1 {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 2.5em;
      font-weight: 900;
      text-align: center;
      letter-spacing: -0.5px;
      position: relative;
      animation: slideDown 0.6s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .subtitle {
      text-align: center;
      color: #6b7280;
      margin-top: 10px;
      font-size: 1.1em;
      font-weight: 500;
    }

    /* Main Grid */
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      animation: fadeIn 0.8s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 968px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Glass Card */
    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: var(--shadow-md);
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
      opacity: 0;
      transition: opacity 0.3s;
    }

    .card:hover::before {
      opacity: 1;
    }

    .card-title {
      font-size: 1.4em;
      font-weight: 700;
      margin-bottom: 8px;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-title::before {
      content: '';
      width: 6px;
      height: 24px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 3px;
    }

    .card-desc {
      color: #6b7280;
      margin-bottom: 24px;
      font-size: 0.95em;
      line-height: 1.6;
    }

    /* Upload Area */
    .upload-area {
      border: 3px dashed #d1d5db;
      border-radius: 16px;
      padding: 50px 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-height: 250px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
      position: relative;
      overflow: hidden;
    }

    .upload-area::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(139, 92, 246, 0.1), transparent);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .upload-area:hover::before {
      width: 300px;
      height: 300px;
    }

    .upload-area:hover {
      border-color: var(--primary);
      background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
      transform: scale(1.02);
    }

    .upload-area img {
      max-width: 100%;
      max-height: 350px;
      border-radius: 12px;
      box-shadow: var(--shadow-md);
      position: relative;
      z-index: 1;
    }

    .upload-icon {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      color: var(--primary);
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .upload-text {
      font-size: 1.1em;
      font-weight: 600;
      color: #4b5563;
      margin-top: 12px;
    }

    .upload-hint {
      font-size: 0.9em;
      color: #9ca3af;
      margin-top: 8px;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 24px;
    }

    label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: #374151;
      font-size: 0.95em;
    }

    select, input[type="range"] {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 1em;
      transition: all 0.3s;
      background: white;
      font-family: inherit;
    }

    select:focus, input[type="range"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
    }

    select:hover {
      border-color: var(--primary);
    }

    input[type="range"] {
      -webkit-appearance: none;
      height: 8px;
      background: linear-gradient(90deg, #e5e7eb 0%, var(--primary) 100%);
      border-radius: 4px;
      padding: 0;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 24px;
      height: 24px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    /* Buttons */
    button {
      width: 100%;
      padding: 14px 24px;
      border: none;
      border-radius: 12px;
      font-size: 1.05em;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin-top: 12px;
      font-family: inherit;
      position: relative;
      overflow: hidden;
    }

    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    button:hover::before {
      width: 300px;
      height: 300px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(139, 92, 246, 0.5);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      color: #374151;
      box-shadow: var(--shadow-sm);
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    button:disabled:hover {
      box-shadow: var(--shadow-sm);
    }

    /* Sticker Grid */
    .sticker-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 24px;
    }

    @media (max-width: 768px) {
      .sticker-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .sticker-item {
      position: relative;
      aspect-ratio: 688/512;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: white;
    }

    .sticker-item:hover {
      transform: scale(1.05) rotate(2deg);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
      border-color: var(--primary);
      z-index: 10;
    }

    .sticker-item img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .sticker-item::after {
      content: 'é»æ“Šä¸‹è¼‰';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 8px;
      text-align: center;
      font-size: 0.85em;
      font-weight: 600;
      opacity: 0;
      transform: translateY(100%);
      transition: all 0.3s;
    }

    .sticker-item:hover::after {
      opacity: 1;
      transform: translateY(0);
    }

    /* Progress Bar */
    .progress-bar {
      width: 100%;
      height: 10px;
      background: #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 16px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
      background-size: 200% 100%;
      transition: width 0.3s;
      animation: progressShine 2s linear infinite;
    }

    @keyframes progressShine {
      0% { background-position: 0% 0%; }
      100% { background-position: 200% 0%; }
    }

    .status-text {
      text-align: center;
      color: #6b7280;
      margin-top: 12px;
      font-size: 0.95em;
      font-weight: 500;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 40px;
      border-radius: 24px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(40px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-title {
      font-size: 1.8em;
      font-weight: 700;
      margin-bottom: 12px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .modal-desc {
      color: #6b7280;
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .modal-desc a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
    }

    .modal-desc a:hover {
      text-decoration: underline;
    }

    input[type="password"], input[type="text"] {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 1em;
      margin-bottom: 20px;
      transition: all 0.3s;
      font-family: inherit;
    }

    input[type="password"]:focus, input[type="text"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
    }

    .generated-image {
      width: 100%;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-md);
    }

    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Icon Styles */
    .icon {
      width: 48px;
      height: 48px;
      color: var(--primary);
      margin-bottom: 12px;
    }

    /* Badge */
    .badge {
      display: inline-block;
      padding: 6px 12px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
      margin-left: 8px;
    }

    /* Tooltip */
    [data-tooltip] {
      position: relative;
      cursor: help;
    }

    [data-tooltip]::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      background: #1f2937;
      color: white;
      border-radius: 8px;
      font-size: 0.85em;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      margin-bottom: 8px;
    }

    [data-tooltip]:hover::after {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ¨ LINEè²¼åœ–è£½ä½œå·¥å…·</h1>
      <div class="subtitle">AIæ™ºèƒ½ç”Ÿæˆ Â· ä¸€éµå»èƒŒè£åˆ‡ Â· å°ˆæ¥­å“è³ªè¼¸å‡º</div>
    </header>

    <div class="main-grid">
      <!-- Left Panel -->
      <div>
        <!-- Upload Card -->
        <div class="card">
          <div class="card-title">ğŸ“¸ ä¸Šå‚³è§’è‰²åœ–ç‰‡</div>
          <div class="card-desc">æ”¯æŒPNGã€JPGæ ¼å¼ï¼Œå»ºè­°ä½¿ç”¨æ¸…æ™°çš„è§’è‰²åœ–ç‰‡ä»¥ç²å¾—æœ€ä½³æ•ˆæœ</div>
          <div class="upload-area" id="uploadArea">
            <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
            </svg>
            <div class="upload-text">é»æ“Šæˆ–æ‹–æ‹½ä¸Šå‚³åœ–ç‰‡</div>
            <div class="upload-hint">æ”¯æŒ PNGã€JPG æ ¼å¼</div>
          </div>
          <input type="file" id="fileInput" accept="image/png,image/jpeg" style="display: none;">
        </div>

        <!-- Settings Card -->
        <div class="card" style="margin-top: 24px;">
          <div class="card-title">âš™ï¸ é¢¨æ ¼è¨­å®š</div>
          <div class="card-desc">è‡ªå®šç¾©è²¼åœ–ä¸»é¡Œã€é¢¨æ ¼å’Œå­—é«”ï¼Œæ‰“é€ ç¨ä¸€ç„¡äºŒçš„å°ˆå±¬è²¼åœ–</div>
          
          <div class="form-group">
            <label>ğŸ­ ä¸»é¡Œ</label>
            <select id="themeSelect"></select>
          </div>

          <div class="form-group">
            <label>ğŸ¨ é¢¨æ ¼</label>
            <select id="styleSelect"></select>
          </div>

          <div class="form-group">
            <label>âœï¸ å­—é«”</label>
            <select id="fontSelect"></select>
          </div>

          <div class="form-group">
            <label>ğŸ“ ç™½é‚Šå¯¬åº¦: <span id="borderValue" style="color: var(--primary); font-weight: 700;">10</span>px</label>
            <input type="range" id="borderWidth" min="0" max="30" value="10">
          </div>

          <button class="btn-secondary" onclick="showApiKeyModal()">ğŸ”‘ è¨­ç½®API Key</button>
          <button class="btn-primary" id="generateBtn" onclick="handleGenerate()">
            âœ¨ ç”Ÿæˆè²¼åœ–
          </button>
        </div>
      </div>

      <!-- Right Panel -->
      <div>
        <!-- Generated Image -->
        <div class="card" id="generatedCard" style="display: none;">
          <div class="card-title">ğŸ–¼ï¸ AIç”Ÿæˆçµæœ</div>
          <div class="card-desc">12å®®æ ¼è²¼åœ–å·²ç”Ÿæˆå®Œæˆï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•é€²è¡Œè™•ç†</div>
          <img id="generatedImage" class="generated-image">
          <button class="btn-primary" onclick="handleProcess()">
            âœ‚ï¸ è™•ç†è²¼åœ–ï¼ˆå»èƒŒ+è£åˆ‡+ç™½é‚Šï¼‰
          </button>
        </div>

        <!-- Stickers Grid -->
        <div class="card" id="stickersCard" style="display: none;">
          <div class="card-title">âœ… è™•ç†å®Œæˆ<span class="badge">12å¼µ</span></div>
          <div class="card-desc">é»æ“Šä»»æ„è²¼åœ–å³å¯å–®ç¨ä¸‹è¼‰ï¼Œæˆ–ä½¿ç”¨ä¸‹æ–¹æŒ‰éˆ•æ‰¹é‡ä¸‹è¼‰</div>
          <div class="sticker-grid" id="stickerGrid"></div>
          <button class="btn-primary" onclick="downloadAllAsZip()">
            ğŸ“¦ ä¸‹è¼‰å…¨éƒ¨ï¼ˆZIPï¼‰
          </button>
        </div>

        <!-- Progress -->
        <div class="card" id="progressCard" style="display: none;">
          <div class="status-text" id="statusText">è™•ç†ä¸­...</div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- API Key Modal -->
  <div class="modal" id="apiKeyModal">
    <div class="modal-content">
      <div class="modal-title">ğŸ”‘ è¨­ç½®Gemini API Key</div>
      <div class="modal-desc">
        è«‹è¼¸å…¥æ‚¨çš„Google Gemini API Keyã€‚æ‚¨å¯ä»¥åœ¨
        <a href="https://aistudio.google.com/apikey" target="_blank">Google AI Studio</a>
        å…è²»ç²å–API Keyã€‚
      </div>
      <input type="password" id="apiKeyInput" placeholder="è¼¸å…¥æ‚¨çš„API Key">
      <button class="btn-primary" onclick="saveApiKey()">âœ… ç¢ºèªä¿å­˜</button>
    </div>
  </div>

  <canvas id="canvas" style="display: none;"></canvas>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    // Constants
    const THEME_PROMPTS = {
      // æ—¥å¸¸ç”Ÿæ´»é¡
      "ç¤¾ç•œæ—¥å¸¸ (é è¨­)": "Corporate Slave (ç¤¾ç•œ) daily office life (e.g., tired, fake smile, drinking coffee, typing furiously, salary day, overtime, I want to go home).",
      "æ—¥å¸¸ç”Ÿæ´»": "Daily Life (æ—¥å¸¸ç”Ÿæ´»), casual interactions, greetings (Hello, Good night, OK, Thanks), sleeping, eating, playing phone, daily struggles.",
      "å–œæ€’å“€æ¨‚": "Emotional Expressions (å–œæ€’å“€æ¨‚), exaggerated facial expressions, happy, angry, sad, joyful, crying, laughing out loud, shocked, rolling eyes.",
      "è€å»¢äººç”Ÿ": "Lazy Life (è€å»¢äººç”Ÿ), lying in bed, potato couch, refusing to work, sleepy, messy hair, eating snacks, doing nothing, don't bother me.",
      "å®…åœ¨å®¶è£¡": "Stay at Home (å®…åœ¨å®¶), gaming all day, watching series, ordering delivery, pajamas all day, messy room, comfort zone, introvert life.",
      "é€šå‹¤åœ°ç„": "Commute Hell (é€šå‹¤åœ°ç„), crowded train, traffic jam, running late, sleepy morning, packed subway, road rage, finally home.",
      
      // æƒ…æ„Ÿé—œä¿‚é¡
      "æƒ…ä¾¶æ”¾é–ƒ": "Couples in Love (æƒ…ä¾¶æ”¾é–ƒ), romantic gestures, hugging, kissing, missing you, heart eyes, sweet moments, dating, love you.",
      "å–®èº«ç‹—æ—¥å¸¸": "Single Life (å–®èº«ç‹—), forever alone, eating alone, third wheel, watching couples, self love, independent, freedom.",
      "å¥½å‹äº’å—†": "Roasting Friends (å¥½å‹äº’å—†), sarcastic jokes, teasing, playful insults, best friend banter, inside jokes, savage comebacks.",
      "å®¶åº­æº«é¦¨": "Family Warmth (å®¶åº­æº«é¦¨), family dinner, parents nagging, sibling fights, grandparents love, home sweet home, family reunion.",
      
      // èˆˆè¶£æ„›å¥½é¡
      "ç¾é£Ÿåƒè²¨": "Foodie Life (ç¾é£Ÿåƒè²¨), drooling, eating huge meals, drinking boba tea, hungry, satisfied, food coma, midnight snack, yummy.",
      "é‹å‹•å¥èº«": "Workout & Fitness (é‹å‹•å¥èº«), gym, running, yoga, sweating, muscles, tired after workout, protein shake, motivation, weight loss.",
      "è²“å¥´æ—¥å¸¸": "Cat Lover (è²“å¥´æ—¥å¸¸), playing with cats, feeding, cleaning litter, being ignored by cat, cat ears, cute paws, meow.",
      "ç‹—æ´¾ç”Ÿæ´»": "Dog Lover (ç‹—æ´¾ç”Ÿæ´»), walking dog, playing fetch, happy tail wagging, puppy eyes, loyal companion, messy room, woof.",
      "éŠæˆ²ç©å®¶": "Gamer Life (éŠæˆ²ç©å®¶), playing games, rage quit, victory, defeat, grinding, loot box, GG, one more game.",
      "è¿½åŠ‡ç‹‚é­”": "Binge Watching (è¿½åŠ‡ç‹‚é­”), Netflix marathon, one more episode, spoiler alert, plot twist, crying over drama, can't stop watching.",
      "è³¼ç‰©ç‹‚": "Shopaholic (è³¼ç‰©ç‹‚), online shopping, delivery arrived, broke but happy, shopping spree, credit card maxed, retail therapy.",
      
      // å­¸ç¿’å·¥ä½œé¡
      "æ ¡åœ’ç”Ÿæ´»": "School Life (æ ¡åœ’ç”Ÿæ´»), studying, exams, recess, homework, graduation, crush on classmate, teacher scolding, reading books.",
      "è€ƒè©¦åœ°ç„": "Exam Hell (è€ƒè©¦åœ°ç„), cramming, all-nighter, brain dead, test anxiety, blank mind, finally done, results day.",
      "æ–°æ‰‹çˆ¸åª½": "New Parents (æ–°æ‰‹çˆ¸åª½), feeding baby, changing diapers, tired eyes, baby crying, happy family, holding baby, milk bottle.",
      "å‰µæ¥­æ‰“æ‹¼": "Startup Hustle (å‰µæ¥­æ‰“æ‹¼), working late, pitching ideas, funding secured, pivot, burnout, success celebration, never give up.",
      
      // æ—…éŠä¼‘é–’é¡
      "æ—¥æœ¬æ—…éŠ": "Japan Travel (æ—¥æœ¬æ—…éŠ), sightseeing, eating ramen, hot springs, kimono, taking photos, shopping, excited tourist vibes, flight, luggage.",
      "æ­æ´²ä¹‹æ—…": "Europe Travel (æ­æ´²ä¹‹æ—…), Eiffel Tower, museums, wine tasting, backpacking, getting lost, beautiful scenery, culture shock.",
      "æµ·å³¶åº¦å‡": "Beach Vacation (æµ·å³¶åº¦å‡), sunbathing, swimming, cocktails, sunset, relaxing, snorkeling, paradise vibes, tan lines.",
      "éœ²ç‡Ÿé‡é¤": "Camping & Picnic (éœ²ç‡Ÿé‡é¤), tent setup, campfire, stargazing, hiking, nature, BBQ, outdoor adventure, bugs everywhere.",
      
      // ç¯€æ…¶ç‰¹æ®Šé¡
      "ç¯€æ—¥æ…¶ç¥": "Festival Celebration (ç¯€æ—¥æ…¶ç¥), Birthday, New Year, Christmas, red envelopes, party poppers, cake, fireworks, congratulations.",
      "è¬è–ç¯€": "Halloween (è¬è–ç¯€), trick or treat, costumes, pumpkins, spooky, candy, haunted house, scary faces, ghost vibes.",
      "æƒ…äººç¯€": "Valentine's Day (æƒ…äººç¯€), roses, chocolates, romantic dinner, love letters, heart shapes, couple goals, forever together.",
      "è¾²æ›†æ–°å¹´": "Lunar New Year (è¾²æ›†æ–°å¹´), red envelopes, family reunion, dumplings, firecrackers, zodiac animals, prosperity, good fortune.",
      
      // ç¶²è·¯æ–‡åŒ–é¡
      "ç¶²è·¯ç”¨èª": "Internet Slang (ç¶²è·¯ç”¨èª), LOL, OMG, facepalm, trending memes, keyboard warrior, like & subscribe, +1.",
      "è¿·å› æ¢—åœ–": "Trending Memes (è¿·å› æ¢—åœ–), funny poses, viral internet culture references, sarcastic humor, troll face vibes, funny faces.",
      "ç›´æ’­ä¸»": "Streamer Life (ç›´æ’­ä¸»), going live, chat interaction, donations, subscribers, technical issues, viral moment, streaming setup.",
      "ç¤¾ç¾¤åª’é«”": "Social Media (ç¤¾ç¾¤åª’é«”), selfie, posting, likes, followers, influencer, hashtags, viral content, scrolling endlessly.",
      
      // æƒ…ç·’å¿ƒç†é¡
      "æ­£èƒ½é‡èªéŒ„": "Positive Vibes (æ­£èƒ½é‡èªéŒ„), fighting!, you can do it, good morning, thumbs up, sunshine, motivation, cheer up.",
      "è² èƒ½é‡é‡‹æ”¾": "Negative Energy (è² èƒ½é‡é‡‹æ”¾), depression, dark cloud, soul leaving body, giving up, I want to go home, social battery dead.",
      "ç„¦æ…®äººç”Ÿ": "Anxiety Life (ç„¦æ…®äººç”Ÿ), overthinking, panic, stress, worried, nervous breakdown, existential crisis, need therapy.",
      "ä½›ç³»äººç”Ÿ": "Zen Life (ä½›ç³»äººç”Ÿ), whatever, don't care, go with flow, inner peace, meditation, letting go, everything is fine."
    };

    const STYLE_PROMPTS = {
      // åŸºç¤é¢¨æ ¼
      "åŸç‰ˆé¢¨æ ¼": "Keep the original style of the input image, consistent character design.",
      
      // å¯«å¯¦ç³»åˆ—
      "å¯«å¯¦å…‰å½±": "Photorealistic, hyperrealistic, cinematic lighting, highly detailed textures, natural colors, ray tracing, global illumination, depth of field, sharp focus, 8k resolution, photographic quality, realistic shadows.",
      "é›»å½±è³ªæ„Ÿ": "Cinematic photography, movie poster style, dramatic lighting, film grain, anamorphic lens flare, color grading, Hollywood production quality, epic composition.",
      "æ²¹ç•«è³ªæ„Ÿ": "Oil painting style, thick brush strokes, impasto technique, rich colors, textured canvas, classical art, Renaissance painting, museum quality.",
      
      // äºæ´²æ¼«ç•«ç³»åˆ—
      "æ—¥å¼æ¼«ç•«": "Japanese anime style, light novel illustration, mobile game CG, official art, high quality, vibrant colors, cel shading, high-gloss finish, glowing effects, bloom, rim lighting, pastel blue and white color palette.",
      "å°‘å¥³æ¼«ç•«": "Shoujo manga style, sparkles and flowers, big expressive eyes, soft pastel colors, romantic atmosphere, delicate linework, dreamy backgrounds.",
      "å°‘å¹´æ¼«ç•«": "Shounen manga style, dynamic action poses, speed lines, bold inking, energetic composition, intense expressions, power-up effects.",
      "éŸ“å¼æ¼«ç•«": "Korean webtoon, manhwa style, high quality, high detail, smooth coloring, clean lineart, volumetric lighting, pastel colors, glowing skin, subtle shading.",
      "ä¸­å¼æ°´å¢¨ç•«": "Traditional Chinese ink painting, guohua style, ink wash painting, expressive brush strokes, flowing ink, calligraphy strokes, watercolor blend, monochrome palette with muted earthy tones, rice paper texture, negative space, atmospheric.",
      
      // è¥¿æ–¹æ¼«ç•«ç³»åˆ—
      "ç¾å¼æ¼«ç•«": "American comic book style, graphic novel art, bold outlines, heavy inking, cross-hatching shadows, high contrast, vibrant and saturated colors, halftone dots texture, dynamic composition, retro comic feel, muscular anatomy.",
      "æ­æ´²æ¼«ç•«": "European comic style, ligne claire, Tintin style, clean lines, flat colors, detailed backgrounds, Franco-Belgian comics, artistic storytelling.",
      
      // å¯æ„›ç³»åˆ—
      "å¯æ„›Qç‰ˆæ¼«ç•«": "Chibi style, super deformed (SD), cute, kawaii, simplified anatomy, large heads small bodies, clean thick lines, soft coloring, pastel color palette, cheerful atmosphere, expressive faces, sticker art style.",
      "ä¸‰éº—é·—é¢¨æ ¼": "Sanrio style, Hello Kitty aesthetic, extremely cute, pastel rainbow colors, kawaii culture, simple shapes, adorable characters, merchandise design.",
      "è»ŸèŒé¢¨æ ¼": "Soft and fluffy style, marshmallow aesthetic, gentle gradients, rounded shapes, baby colors, cozy atmosphere, plushie texture.",
      
      // å‹•ç•«é¢¨æ ¼
      "è¿ªå£«å°¼é¢¨æ ¼å‹•ç•«": "Disney animation style, Pixar style, stylized 3D render, highly polished, expressive character design, appealing soft shapes, vibrant and warm color palette, soft global illumination, subsurface scattering, fairytale atmosphere, cinematic feel.",
      "å‰åœåŠ›é¢¨æ ¼": "Studio Ghibli style, Hayao Miyazaki aesthetic, hand-drawn animation, watercolor backgrounds, nostalgic atmosphere, whimsical characters, nature elements.",
      "å¤¢å·¥å» é¢¨æ ¼": "DreamWorks animation style, expressive faces, dynamic poses, vibrant colors, comedic timing, modern 3D animation, appealing character design.",
      
      // å¾©å¤ç³»åˆ—
      "åƒç´ é¢¨æ ¼": "Pixel art, 8-bit style, 16-bit retro game, low resolution, dot art, visible grid, limited color palette, distinct pixels, dithering shading, nostalgic aesthetic, sprite art.",
      "å¾©å¤å¡é€š": "Vintage cartoon style, 1930s rubber hose animation, black and white, grainy film, old Disney style, bouncy movement, classic animation.",
      "80å¹´ä»£é¢¨æ ¼": "1980s retro style, neon colors, synthwave aesthetic, geometric shapes, bold outlines, vibrant gradients, arcade game vibes.",
      "90å¹´ä»£é¢¨æ ¼": "1990s anime style, retro anime aesthetic, VHS quality, nostalgic colors, classic cel animation, hand-drawn charm.",
      
      // ç¾ä»£æ•¸ä½ç³»åˆ—
      "3Dæ¸²æŸ“é¢¨æ ¼": "3D render, CGI illustration, highly detailed models, realistic textures, physically based rendering (PBR), octane render style, complex lighting, volumetric fog, sharp focus, digital sculpting, clean render pass.",
      "æ‰å¹³åŒ–è¨­è¨ˆ": "Flat design, minimal style, solid colors, no gradients, geometric shapes, modern UI aesthetic, clean and simple, vector art.",
      "Material Design": "Google Material Design style, depth and shadow, bold colors, grid-based layouts, responsive animation, modern digital aesthetic.",
      "è³½åšé¾å…‹": "Cyberpunk style, neon lights, futuristic cityscape, high tech low life, holographic effects, dark atmosphere, sci-fi elements.",
      
      // è—è¡“é¢¨æ ¼
      "æ³¢æ™®è—è¡“": "Pop Art style, Andy Warhol inspired, bold colors, Ben-Day dots, comic book aesthetic, mass culture references, screen printing effect.",
      "æŠ½è±¡è—è¡“": "Abstract art style, geometric shapes, bold colors, non-representational, modern art, expressive composition, artistic interpretation.",
      "å¡—é´‰è—è¡“": "Graffiti art style, street art, spray paint effect, urban culture, bold letters, vibrant colors, hip-hop aesthetic.",
      "å‰ªç´™è—è¡“": "Paper cut art style, layered paper, shadow box effect, handcrafted look, silhouette design, folk art inspiration."
    };

    const FONT_STYLES = {
      // åŸºç¤å­—é«”
      "é»‘é«” (é è¨­)": "Bold Sans-serif, Heiti style, modern, clean, high legibility, standard sticker font",
      "åœ“é«” (å¯æ„›æŸ”å’Œ)": "Rounded Sans-serif, YuanTi style, soft edges, cute, friendly, kawaii typography",
      "æ˜é«” (å„ªé›…ç«¯èŠ)": "Serif font, Mincho style, elegant, traditional, formal, classic typography, readable",
      
      // æ‰‹å¯«ç³»åˆ—
      "æ‰‹å¯«é«” (éš¨æ€§å¡—é´‰)": "Handwritten style, marker pen, casual, personal, messy but cute, notebook doodle style",
      "é‹¼ç­†å­— (æµæš¢å„ªç¾)": "Fountain pen calligraphy, flowing strokes, elegant handwriting, cursive style, sophisticated",
      "ç²‰ç­†å­— (é»‘æ¿é¢¨æ ¼)": "Chalk font, blackboard style, rough texture, educational vibe, handwritten chalk letters",
      "è Ÿç­†å­— (ç«¥è¶£å¤©çœŸ)": "Crayon font, child-like writing, colorful strokes, playful, kindergarten aesthetic",
      
      // è—è¡“å­—é«”
      "æ›¸æ³•é«” (æ°£å‹¢ç£…ç¤´)": "Chinese Calligraphy, brush strokes, energetic, traditional ink style, powerful lines",
      "è¡Œæ›¸ (æµæš¢ç€Ÿç‘)": "Running script, semi-cursive, flowing characters, artistic calligraphy, dynamic strokes",
      "ç¯†æ›¸ (å¤å…¸èŠé‡)": "Seal script, ancient Chinese characters, decorative, traditional, historical style",
      
      // ç¾ä»£è¨­è¨ˆ
      "POPé«” (æ´»æ½‘æµ·å ±)": "POP art style, bold bubble letters, heavy outlines, advertisement style, vivid and bouncy",
      "ç¶œè—é«” (èª‡å¼µé†’ç›®)": "Variety show subtitle style, extra bold, exaggerated strokes, attention-grabbing, TV show font",
      "éœ“è™¹å­— (ç™¼å…‰æ•ˆæœ)": "Neon sign font, glowing effect, retro futuristic, bright colors, nightlife aesthetic",
      "ç«‹é«”å­— (3Dæ•ˆæœ)": "3D font, extruded letters, shadow and depth, dimensional typography, bold presence",
      
      // å¯æ„›ç³»åˆ—
      "å¨ƒå¨ƒé«” (ç«¥è¶£å¯æ„›)": "Childish font, crayon style, playful, naive, irregular sizes, kindergarten style",
      "æ³¡æ³¡å­— (åœ“æ½¤Qå½ˆ)": "Bubble font, rounded bubbly letters, soft and bouncy, cute and friendly, cartoon style",
      "æ£‰èŠ±ç³–é«” (è»ŸèŒç”œç¾)": "Marshmallow font, super soft and fluffy, pastel aesthetic, sweet and gentle, kawaii culture",
      
      // å¾©å¤ç³»åˆ—
      "åƒç´ é«” (å¾©å¤éŠæˆ²)": "Pixel font, 8-bit, retro gaming style, blocky, jagged edges, digital look",
      "æ‰“å­—æ©Ÿ (å¾©å¤æ©Ÿæ¢°)": "Typewriter font, monospaced, vintage mechanical, retro office, classic typing style",
      "å ±ç´™é«” (æ–°èæ¨™é¡Œ)": "Newspaper headline font, bold serif, press style, editorial typography, classic news",
      
      // ç‰¹æ®Šé¢¨æ ¼
      "æ¼«ç•«å­— (å‹•æ„Ÿæ´»æ½‘)": "Comic book font, action words, sound effects style, dynamic, energetic, POW BAM style",
      "ææ€–å­— (é©šæ‚šè©­ç•°)": "Horror font, dripping letters, creepy style, Halloween vibe, scary typography",
      "ç§‘æŠ€å­— (æœªä¾†æ„Ÿ)": "Tech font, futuristic, digital display, sci-fi style, modern technology, sleek design",
      "å¡—é´‰å­— (è¡—é ­é¢¨æ ¼)": "Graffiti font, street art style, urban culture, spray paint effect, hip-hop typography"
    };

    const STICKER_CONFIG = {
      COLS: 4,
      ROWS: 3,
      CELL_WIDTH: 688,
      CELL_HEIGHT: 512
    };

    // State
    let apiKey = localStorage.getItem('gemini_api_key') || '';
    let uploadedImage = null;
    let generatedImage = null;
    let stickers = [];
    let loading = false;

    // Initialize
    function init() {
      // Populate selects
      const themeSelect = document.getElementById('themeSelect');
      Object.keys(THEME_PROMPTS).forEach(theme => {
        const option = document.createElement('option');
        option.value = theme;
        option.textContent = theme;
        themeSelect.appendChild(option);
      });

      const styleSelect = document.getElementById('styleSelect');
      Object.keys(STYLE_PROMPTS).forEach(style => {
        const option = document.createElement('option');
        option.value = style;
        option.textContent = style;
        styleSelect.appendChild(option);
      });

      const fontSelect = document.getElementById('fontSelect');
      Object.keys(FONT_STYLES).forEach(font => {
        const option = document.createElement('option');
        option.value = font;
        option.textContent = font;
        fontSelect.appendChild(option);
      });

      // Event listeners
      document.getElementById('uploadArea').addEventListener('click', () => {
        document.getElementById('fileInput').click();
      });

      document.getElementById('fileInput').addEventListener('change', handleFileUpload);

      document.getElementById('borderWidth').addEventListener('input', (e) => {
        document.getElementById('borderValue').textContent = e.target.value;
      });

      // Drag and drop
      const uploadArea = document.getElementById('uploadArea');
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--primary)';
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.style.borderColor = '#d1d5db';
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#d1d5db';
        const file = e.dataTransfer.files[0];
        if (file && (file.type === 'image/png' || file.type === 'image/jpeg')) {
          handleFile(file);
        }
      });
    }

    function handleFileUpload(e) {
      const file = e.target.files[0];
      if (file) {
        handleFile(file);
      }
    }

    function handleFile(file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        uploadedImage = event.target.result;
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.innerHTML = `<img src="${uploadedImage}" alt="Uploaded">`;
        
        // Reset
        generatedImage = null;
        stickers = [];
        document.getElementById('generatedCard').style.display = 'none';
        document.getElementById('stickersCard').style.display = 'none';
      };
      reader.readAsDataURL(file);
    }

    function showApiKeyModal() {
      document.getElementById('apiKeyModal').classList.add('show');
      document.getElementById('apiKeyInput').value = apiKey;
    }

    function saveApiKey() {
      apiKey = document.getElementById('apiKeyInput').value;
      if (apiKey) {
        localStorage.setItem('gemini_api_key', apiKey);
        document.getElementById('apiKeyModal').classList.remove('show');
        alert('âœ… API Keyå·²ä¿å­˜æˆåŠŸï¼');
      } else {
        alert('âš ï¸ è«‹è¼¸å…¥API Key');
      }
    }

    async function handleGenerate() {
      if (!apiKey) {
        showApiKeyModal();
        return;
      }

      if (!uploadedImage) {
        alert('âš ï¸ è«‹å…ˆä¸Šå‚³ä¸€å¼µè§’è‰²åœ–ç‰‡ï¼');
        return;
      }

      loading = true;
      showProgress('ğŸ¨ æ­£åœ¨å‘¼å«AIè¨­è¨ˆå¸«ç”Ÿæˆè²¼åœ–...', 10);
      const btn = document.getElementById('generateBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>ç”Ÿæˆä¸­...';

      try {
        const theme = document.getElementById('themeSelect').value;
        const style = document.getElementById('styleSelect').value;
        const font = document.getElementById('fontSelect').value;

        const MODEL_NAME = "gemini-3-pro-image-preview";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;

        const base64Image = uploadedImage.split(',')[1];
        const themeDescription = THEME_PROMPTS[theme];
        const styleDescription = STYLE_PROMPTS[style];
        const fontDescription = FONT_STYLES[font];

        // æ·»åŠ éš¨æ©Ÿç¨®å­ç¢ºä¿æ¯æ¬¡ç”Ÿæˆä¸åŒ
        const randomSeed = Math.floor(Math.random() * 1000000);
        const timestamp = Date.now();
        
        const promptText = `
Create a sprite sheet of 12 Line stickers (4 columns x 3 rows).

[Generation ID: ${randomSeed}-${timestamp}] - This ensures unique output each time.

Requirements:
1. Character: Based on the input image provided.
2. Theme: "${themeDescription}"
3. Text: Include funny phrases related to the theme. 
   - **IMPORTANT**: ALL TEXT MUST BE IN **TRADITIONAL CHINESE (ç¹é«”ä¸­æ–‡)**. Do NOT use Simplified Chinese or English.
   - **VARIETY**: Use DIFFERENT phrases for each sticker. Be creative and diverse.
4. Typography: 
   - Style: "${fontDescription}"
   - Color: Use vibrant, lively colors (e.g., bright orange, hot pink, cyan, red, purple). **ABSOLUTELY NO GREEN** or colors close to RGB(0, 255, 0) for text, as it will be removed by the green screen filter.
   - Effects: **MUST add a 2-3px thick WHITE OUTLINE (stroke)** around all text to ensure readability on any background.
   - Size: Large, legible, and integrated into the sticker design.
5. Layout: Strictly arrange in a grid of 4 columns and 3 rows. The total image aspect ratio is 16:9.
6. Background: Use a **pure green screen background (RGB 0, 255, 0)** for the entire canvas. This green will be removed later.
7. Style: "${styleDescription}"
8. Output: A single image containing all 12 stickers in a 4x3 grid layout.

IMPORTANT:
- Each sticker should have UNIQUE and DISTINCT poses, expressions, and text.
- Vary the composition, angles, and emotions across all 12 stickers.
- Text must be in Traditional Chinese with white outlines.
- Background MUST be pure green (RGB 0, 255, 0).
- NO green colors in the character or text.
- Make each generation DIFFERENT from previous ones by using creative variations.
        `;

        updateProgress(30);

        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{
              parts: [
                { text: promptText },
                {
                  inlineData: {
                    mimeType: "image/png",
                    data: base64Image
                  }
                }
              ]
            }],
            generationConfig: {
              responseModalities: ["TEXT", "IMAGE"],
              imageConfig: {
                aspectRatio: "16:9",
                imageSize: "2K"
              },
              temperature: 1.0,
              topK: 40,
              topP: 0.95,
              seed: randomSeed
            }
          })
        });

        if (!response.ok) {
          const errData = await response.json();
          console.error('API Error:', errData);
          throw new Error(errData.error?.message || 'APIè«‹æ±‚å¤±æ•—');
        }

        const data = await response.json();
        console.log('API Response:', data);
        
        // è§£æGeminiè¿”å›çš„åœ–ç‰‡
        let foundImage = null;
        const candidates = data.candidates || [];
        
        for (const candidate of candidates) {
          if (candidate.content && candidate.content.parts) {
            for (const part of candidate.content.parts) {
              if (part.inlineData && part.inlineData.mimeType && part.inlineData.mimeType.startsWith('image')) {
                foundImage = `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                console.log('Found image in inlineData with mimeType:', part.inlineData.mimeType);
                break;
              }
              if (part.inline_data && part.inline_data.mime_type && part.inline_data.mime_type.startsWith('image')) {
                foundImage = `data:${part.inline_data.mime_type};base64,${part.inline_data.data}`;
                console.log('Found image in inline_data with mime_type:', part.inline_data.mime_type);
                break;
              }
            }
          }
          if (foundImage) break;
        }

        if (!foundImage) {
          console.error('No image found in response. Full response:', JSON.stringify(data, null, 2));
          throw new Error('æ¨¡å‹æ²’æœ‰ç”Ÿæˆåœ–ç‰‡,è«‹é‡è©¦ï¼ˆå¯èƒ½æ˜¯è¢«å®‰å…¨éæ¿¾æ””æˆªï¼‰');
        }
        
        generatedImage = foundImage;
        document.getElementById('generatedImage').src = generatedImage;
        document.getElementById('generatedCard').style.display = 'block';

        updateProgress(100);
        hideProgress();
        alert('âœ… è²¼åœ–ç”ŸæˆæˆåŠŸï¼');
      } catch (error) {
        console.error('Generation Error:', error);
        alert('âŒ ç”Ÿæˆå¤±æ•—ï¼š' + error.message);
        hideProgress();
      } finally {
        loading = false;
        btn.disabled = false;
        btn.innerHTML = 'âœ¨ ç”Ÿæˆè²¼åœ–';
      }
    }

    async function handleProcess() {
      if (!generatedImage) {
        alert('âš ï¸ è«‹å…ˆç”Ÿæˆè²¼åœ–ï¼');
        return;
      }

      showProgress('ğŸ­ æ­£åœ¨å»èƒŒ...', 20);

      try {
        // 1. Remove green screen
        const removedBg = await removeGreenScreen(generatedImage);
        updateProgress(40);

        // 2. Crop stickers
        showProgress('âœ‚ï¸ æ­£åœ¨è£åˆ‡è²¼åœ–...', 40);
        const cropped = await cropStickers(removedBg);
        updateProgress(60);

        // 3. Add white border
        showProgress('ğŸ–¼ï¸ æ­£åœ¨æ·»åŠ ç™½é‚Š...', 60);
        const borderWidth = parseInt(document.getElementById('borderWidth').value);
        stickers = await addWhiteBorderBatch(cropped, borderWidth);
        updateProgress(80);

        // 4. Display stickers
        displayStickers();
        updateProgress(100);
        hideProgress();

        document.getElementById('stickersCard').style.display = 'block';
        alert('âœ… è™•ç†å®Œæˆï¼å…±12å¼µè²¼åœ–');
      } catch (error) {
        console.error('Processing Error:', error);
        alert('âŒ è™•ç†å¤±æ•—ï¼š' + error.message);
        hideProgress();
      }
    }

    function removeGreenScreen(imageUrl, threshold = 50) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);

          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;

          for (let i = 0; i < data.length; i += 4) {
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];

            if (g > r + threshold && g > b + threshold && g > 100) {
              data[i + 3] = 0;
            }
          }

          ctx.putImageData(imageData, 0, 0);
          resolve(canvas.toDataURL('image/png'));
        };

        img.onerror = () => reject(new Error('åœ–ç‰‡åŠ è¼‰å¤±æ•—'));
        img.src = imageUrl;
      });
    }

    function cropStickers(imageUrl) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        
        img.onload = () => {
          const { COLS, ROWS, CELL_WIDTH, CELL_HEIGHT } = STICKER_CONFIG;
          const stickers = [];

          for (let row = 0; row < ROWS; row++) {
            for (let col = 0; col < COLS; col++) {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');

              canvas.width = CELL_WIDTH;
              canvas.height = CELL_HEIGHT;

              const sx = (img.width / COLS) * col;
              const sy = (img.height / ROWS) * row;
              const sw = img.width / COLS;
              const sh = img.height / ROWS;

              ctx.drawImage(img, sx, sy, sw, sh, 0, 0, CELL_WIDTH, CELL_HEIGHT);
              stickers.push(canvas.toDataURL('image/png'));
            }
          }

          resolve(stickers);
        };

        img.onerror = () => reject(new Error('åœ–ç‰‡åŠ è¼‰å¤±æ•—'));
        img.src = imageUrl;
      });
    }

    function addWhiteBorder(imageUrl, borderWidth) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');

          canvas.width = img.width + borderWidth * 2;
          canvas.height = img.height + borderWidth * 2;

          ctx.fillStyle = 'white';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, borderWidth, borderWidth);

          resolve(canvas.toDataURL('image/png'));
        };

        img.onerror = () => reject(new Error('åœ–ç‰‡åŠ è¼‰å¤±æ•—'));
        img.src = imageUrl;
      });
    }

    async function addWhiteBorderBatch(imageUrls, borderWidth) {
      return Promise.all(imageUrls.map(url => addWhiteBorder(url, borderWidth)));
    }

    function displayStickers() {
      const grid = document.getElementById('stickerGrid');
      grid.innerHTML = '';

      stickers.forEach((sticker, index) => {
        const div = document.createElement('div');
        div.className = 'sticker-item';
        div.onclick = () => downloadImage(sticker, `LINE_sticker_${index + 1}.png`);
        
        const img = document.createElement('img');
        img.src = sticker;
        div.appendChild(img);
        
        grid.appendChild(div);
      });
    }

    function downloadImage(dataUrl, filename) {
      const link = document.createElement('a');
      link.href = dataUrl;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    async function downloadAllAsZip() {
      if (stickers.length === 0) {
        alert('âš ï¸ æ²’æœ‰å¯ä¸‹è¼‰çš„è²¼åœ–ï¼');
        return;
      }

      try {
        const zip = new JSZip();

        for (let i = 0; i < stickers.length; i++) {
          const base64Data = stickers[i].split(',')[1];
          zip.file(`LINE_sticker_${i + 1}.png`, base64Data, { base64: true });
        }

        const blob = await zip.generateAsync({ type: 'blob' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'LINE_stickers_' + Date.now() + '.zip';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);

        alert('âœ… ä¸‹è¼‰æˆåŠŸï¼å…±12å¼µè²¼åœ–');
      } catch (error) {
        alert('âŒ ä¸‹è¼‰å¤±æ•—ï¼š' + error.message);
        console.error(error);
      }
    }

    function showProgress(text, progress) {
      document.getElementById('progressCard').style.display = 'block';
      document.getElementById('statusText').textContent = text;
      document.getElementById('progressFill').style.width = progress + '%';
    }

    function updateProgress(progress) {
      document.getElementById('progressFill').style.width = progress + '%';
    }

    function hideProgress() {
      setTimeout(() => {
        document.getElementById('progressCard').style.display = 'none';
      }, 500);
    }

    // Close modal when clicking outside
    document.getElementById('apiKeyModal').addEventListener('click', (e) => {
      if (e.target.id === 'apiKeyModal') {
        document.getElementById('apiKeyModal').classList.remove('show');
      }
    });

    // Initialize on load
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
