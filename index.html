<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LINEè²¼åœ–è£½ä½œå·¥å…· - AIæ™ºèƒ½ç”Ÿæˆ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #8b5cf6;
      --primary-dark: #7c3aed;
      --secondary: #ec4899;
      --accent: #06b6d4;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.15);
      --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.2);
      --shadow-glow: 0 0 30px rgba(139, 92, 246, 0.3);
    }

    body {
      font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      background-attachment: fixed;
      min-height: 100vh;
      color: #1f2937;
      overflow-x: hidden;
    }

    /* Animated background particles */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 50%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(236, 72, 153, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(6, 182, 212, 0.1) 0%, transparent 50%);
      animation: float 20s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-20px) scale(1.05); }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 1;
    }

    /* Header */
    header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: 30px 40px;
      border-radius: 24px;
      margin-bottom: 30px;
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(255, 255, 255, 0.3);
      position: relative;
      overflow: hidden;
    }

    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.1), transparent);
      animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    h1 {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 2.5em;
      font-weight: 900;
      text-align: center;
      letter-spacing: -0.5px;
      position: relative;
      animation: slideDown 0.6s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .subtitle {
      text-align: center;
      color: #6b7280;
      margin-top: 10px;
      font-size: 1.1em;
      font-weight: 500;
    }

    /* Main Grid */
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      animation: fadeIn 0.8s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 968px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Glass Card */
    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: var(--shadow-md);
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
      opacity: 0;
      transition: opacity 0.3s;
    }

    .card:hover::before {
      opacity: 1;
    }

    .card-title {
      font-size: 1.4em;
      font-weight: 700;
      margin-bottom: 8px;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-title::before {
      content: '';
      width: 6px;
      height: 24px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 3px;
    }

    .card-desc {
      color: #6b7280;
      margin-bottom: 24px;
      font-size: 0.95em;
      line-height: 1.6;
    }

    /* Upload Area */
    .upload-area {
      border: 3px dashed #d1d5db;
      border-radius: 16px;
      padding: 50px 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-height: 250px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
      position: relative;
      overflow: hidden;
    }

    .upload-area::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(139, 92, 246, 0.1), transparent);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .upload-area:hover::before {
      width: 300px;
      height: 300px;
    }

    .upload-area:hover {
      border-color: var(--primary);
      background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
      transform: scale(1.02);
    }

    .upload-area img {
      max-width: 100%;
      max-height: 350px;
      border-radius: 12px;
      box-shadow: var(--shadow-md);
      position: relative;
      z-index: 1;
    }

    .upload-icon {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      color: var(--primary);
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .upload-text {
      font-size: 1.1em;
      font-weight: 600;
      color: #4b5563;
      margin-top: 12px;
    }

    .upload-hint {
      font-size: 0.9em;
      color: #9ca3af;
      margin-top: 8px;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 24px;
    }

    label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: #374151;
      font-size: 0.95em;
    }

    select, input[type="range"] {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 1em;
      transition: all 0.3s;
      background: white;
      font-family: inherit;
    }

    select:focus, input[type="range"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
    }

    select:hover {
      border-color: var(--primary);
    }

    input[type="range"] {
      -webkit-appearance: none;
      height: 8px;
      background: linear-gradient(90deg, #e5e7eb 0%, var(--primary) 100%);
      border-radius: 4px;
      padding: 0;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 24px;
      height: 24px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    /* Buttons */
    button {
      width: 100%;
      padding: 14px 24px;
      border: none;
      border-radius: 12px;
      font-size: 1.05em;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin-top: 12px;
      font-family: inherit;
      position: relative;
      overflow: hidden;
    }

    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    button:hover::before {
      width: 300px;
      height: 300px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(139, 92, 246, 0.5);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      color: #374151;
      box-shadow: var(--shadow-sm);
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    button:disabled:hover {
      box-shadow: var(--shadow-sm);
    }

    /* Sticker Grid */
    .sticker-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 24px;
    }

    @media (max-width: 768px) {
      .sticker-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .sticker-item {
      position: relative;
      aspect-ratio: 688/512;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: white;
    }

    .sticker-item:hover {
      transform: scale(1.05) rotate(2deg);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
      border-color: var(--primary);
      z-index: 10;
    }

    .sticker-item img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .sticker-item::after {
      content: 'é»æ“Šä¸‹è¼‰';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 8px;
      text-align: center;
      font-size: 0.85em;
      font-weight: 600;
      opacity: 0;
      transform: translateY(100%);
      transition: all 0.3s;
    }

    .sticker-item:hover::after {
      opacity: 1;
      transform: translateY(0);
    }

    /* Progress Bar */
    .progress-bar {
      width: 100%;
      height: 10px;
      background: #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 16px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
      background-size: 200% 100%;
      transition: width 0.3s;
      animation: progressShine 2s linear infinite;
    }

    @keyframes progressShine {
      0% { background-position: 0% 0%; }
      100% { background-position: 200% 0%; }
    }

    .status-text {
      text-align: center;
      color: #6b7280;
      margin-top: 12px;
      font-size: 0.95em;
      font-weight: 500;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 40px;
      border-radius: 24px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(40px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-title {
      font-size: 1.8em;
      font-weight: 700;
      margin-bottom: 12px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .modal-desc {
      color: #6b7280;
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .modal-desc a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
    }

    .modal-desc a:hover {
      text-decoration: underline;
    }

    input[type="password"], input[type="text"] {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 1em;
      margin-bottom: 20px;
      transition: all 0.3s;
      font-family: inherit;
    }

    input[type="password"]:focus, input[type="text"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
    }

    .generated-image {
      width: 100%;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-md);
    }

    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Icon Styles */
    .icon {
      width: 48px;
      height: 48px;
      color: var(--primary);
      margin-bottom: 12px;
    }

    /* Badge */
    .badge {
      display: inline-block;
      padding: 6px 12px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
      margin-left: 8px;
    }

    /* Tooltip */
    [data-tooltip] {
      position: relative;
      cursor: help;
    }

    [data-tooltip]::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      background: #1f2937;
      color: white;
      border-radius: 8px;
      font-size: 0.85em;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      margin-bottom: 8px;
    }

    [data-tooltip]:hover::after {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ¨ LINEè²¼åœ–è£½ä½œå·¥å…·</h1>
      <div class="subtitle">AIæ™ºèƒ½ç”Ÿæˆ Â· ä¸€éµå»èƒŒè£åˆ‡ Â· å°ˆæ¥­å“è³ªè¼¸å‡º</div>
    </header>

    <div class="main-grid">
      <!-- Left Panel -->
      <div>
        <!-- Upload Card -->
        <div class="card">
          <div class="card-title">ğŸ“¸ ä¸Šå‚³è§’è‰²åœ–ç‰‡</div>
          <div class="card-desc">æ”¯æŒPNGã€JPGæ ¼å¼ï¼Œå»ºè­°ä½¿ç”¨æ¸…æ™°çš„è§’è‰²åœ–ç‰‡ä»¥ç²å¾—æœ€ä½³æ•ˆæœ</div>
          <div class="upload-area" id="uploadArea">
            <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
            </svg>
            <div class="upload-text">é»æ“Šæˆ–æ‹–æ‹½ä¸Šå‚³åœ–ç‰‡</div>
            <div class="upload-hint">æ”¯æŒ PNGã€JPG æ ¼å¼</div>
          </div>
          <input type="file" id="fileInput" accept="image/png,image/jpeg" style="display: none;">
        </div>

        <!-- Settings Card -->
        <div class="card" style="margin-top: 24px;">
          <div class="card-title">âš™ï¸ é¢¨æ ¼è¨­å®š</div>
          <div class="card-desc">è‡ªå®šç¾©è²¼åœ–ä¸»é¡Œã€é¢¨æ ¼å’Œå­—é«”ï¼Œæ‰“é€ ç¨ä¸€ç„¡äºŒçš„å°ˆå±¬è²¼åœ–</div>
          
          <div class="form-group">
            <label>ğŸ­ ä¸»é¡Œ</label>
            <select id="themeSelect"></select>
          </div>

          <div class="form-group">
            <label>ğŸ¨ é¢¨æ ¼</label>
            <select id="styleSelect"></select>
          </div>

          <div class="form-group">
            <label>âœˆï¸ å­—é«”</label>
            <select id="fontSelect"></select>
          </div>

          <div class="form-group">
            <label>ğŸ¯ ç¶²æ ¼é…ç½®</label>
            <select id="gridConfig">
              <option value="3x3">3x3 (9å¼µè²¼åœ–)</option>
              <option value="4x4" selected>4x4 (16å¼µè²¼åœ–)</option>
              <option value="5x5">5x5 (25å¼µè²¼åœ–)</option>
            </select>
          </div>

          <div class="form-group">
            <label>ğŸ“ ç™½é‚Šå¯¬åº¦: <span id="borderValue" style="color: var(--primary); font-weight: 700;">10</span>px</label>
            <input type="range" id="borderWidth" min="0" max="30" value="10">
          </div>

          <div class="form-group">
            <label>ğŸ”¤ æ–‡å­—å¤§å°</label>
            <select id="textSize">
              <option value="small">å° (24-32px)</option>
              <option value="medium" selected>ä¸­ (36-48px)</option>
              <option value="large">å¤§ (52-64px)</option>
              <option value="xlarge">ç‰¹å¤§ (68-80px)</option>
            </select>
          </div>

          <button class="btn-secondary" onclick="showApiKeyModal()">ğŸ”‘ è¨­ç½®API Key</button>
          <button class="btn-secondary" onclick="showTutorialModal()">ğŸ“š å¦‚ä½•ç”³è«‹API</button>
          <button class="btn-primary" id="generateBtn" onclick="handleGenerate()">
            âœ¨ ç”Ÿæˆè²¼åœ–
          </button>
        </div>
      </div>

      <!-- Right Panel -->
      <div>
        <!-- Generated Image -->
        <div class="card" id="generatedCard" style="display: none;">
          <div class="card-title">ğŸ–¼ï¸ AIç”Ÿæˆçµæœ</div>
          <div class="card-desc">12å®®æ ¼è²¼åœ–å·²ç”Ÿæˆå®Œæˆï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•é€²è¡Œè™•ç†</div>
          <img id="generatedImage" class="generated-image">
          <button class="btn-primary" onclick="handleProcess()">
            âœ‚ï¸ è™•ç†è²¼åœ–ï¼ˆå»èƒŒ+è£åˆ‡+ç™½é‚Šï¼‰
          </button>
        </div>

        <!-- Stickers Grid -->
        <div class="card" id="stickersCard" style="display: none;">
          <div class="card-title">âœ… è™•ç†å®Œæˆ<span class="badge" id="stickerCount">16å¼µ</span></div>
          <div class="card-desc">é»æ“Šä»»æ„è²¼åœ–å³å¯å–®ç¨ä¸‹è¼‰ï¼Œæˆ–ä½¿ç”¨ä¸‹æ–¹æŒ‰éˆ•æ‰¹é‡ä¸‹è¼‰</div>
          <div class="sticker-grid" id="stickerGrid"></div>
          <button class="btn-primary" onclick="downloadAllAsZip()">
            ğŸ“¦ ä¸‹è¼‰å…¨éƒ¨ï¼ˆZIPï¼‰
          </button>
        </div>

        <!-- Progress -->
        <div class="card" id="progressCard" style="display: none;">
          <div class="status-text" id="statusText">è™•ç†ä¸­...</div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- API Key Modal -->
  <div class="modal" id="apiKeyModal">
    <div class="modal-content">
      <span class="close" onclick="closeApiKeyModal()">&times;</span>
      <div class="modal-title">ğŸ”‘ è¨­ç½®API Key</div>
      <div class="modal-desc">
        è«‹è¼¸å…¥æ‚¨çš„Google Gemini API Keyã€‚æ‚¨å¯ä»¥åœ¨
        <a href="https://aistudio.google.com/apikey" target="_blank">Google AI Studio</a>
        å…è²»ç²å–API Keyã€‚
      </div>
      <input type="password" id="apiKeyInput" placeholder="è¼¸å…¥æ‚¨çš„API Key">
      <button class="btn-primary" onclick="saveApiKey()">âœ… ç¢ºèªä¿å­˜</button>
    </div>
  </div>

  <!-- Tutorial Modal -->
  <div class="modal" id="tutorialModal">
    <div class="modal-content" style="max-width: 1200px;">
      <span class="close" onclick="closeTutorialModal()">&times;</span>
      <div class="modal-title">ğŸ“š å¦‚ä½•ç”³è«‹Google AI Studio API é‡‘é‘°</div>
      <div class="modal-desc">
        è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿç²å–å…è²»API Keyï¼Œç„¶å¾Œè²¼åˆ°ã€Œè¨­ç½®API Keyã€ä¸­
      </div>
      <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310519663180163086/nXXhtooOlzUiOzyC.jpg" 
           alt="APIç”³è«‹æ•™å­¸" 
           style="width: 100%; border-radius: 12px; margin-top: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
      <div style="margin-top: 20px; padding: 15px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border-left: 4px solid var(--primary);">
        <strong>âš ï¸ é‡è¦æç¤ºï¼š</strong> API é‡‘é‘°å¦‚åŒå¯†ç¢¼ï¼Œè«‹å‹¿æ´©éœ²ã€‚å»ºè­°é€éå¾Œç«¯ä¼ºæœå™¨å‘¼å«APIã€‚
      </div>
    </div>
  </div>c="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    // Constants (æ“´å……ç‰ˆæœ¬ï¼š60+ä¸»é¡Œã€60+é¢¨æ ¼ã€40+å­—é«”ï¼Œå¸¶åˆ†é¡æ¨™ç±¤)
// æ“´å……çš„ä¸»é¡Œã€é¢¨æ ¼ã€å­—é«”é…ç½®ï¼ˆç´„2å€æ•¸é‡ï¼Œå¸¶åˆ†é¡ï¼‰

const THEME_PROMPTS = {
  // === æ—¥å¸¸ç”Ÿæ´»é¡ ===
  "ã€æ—¥å¸¸ã€‘ç¤¾ç•œæ—¥å¸¸": "Corporate office worker daily life: exhausted, fake smile, drinking coffee, typing frantically, payday excitement, overtime struggles, wanting to go home",
  "ã€æ—¥å¸¸ã€‘æ—¥å¸¸ç”Ÿæ´»": "Everyday casual life: greetings (hello, good night, OK, thanks), sleeping, eating, using phone, daily routines",
  "ã€æ—¥å¸¸ã€‘å–œæ€’å“€æ¨‚": "Basic emotions: happy, angry, sad, joyful, crying, laughing, shocked, eye-rolling, various facial expressions",
  "ã€æ—¥å¸¸ã€‘è€å»¢äººç”Ÿ": "Lazy lifestyle: lying in bed, couch potato, refusing work, sleepy, messy hair, snacking, doing nothing",
  "ã€æ—¥å¸¸ã€‘å®…åœ¨å®¶": "Staying home: gaming, binge-watching, ordering food, wearing pajamas all day, messy room, comfort zone",
  "ã€æ—¥å¸¸ã€‘é€šå‹¤åœ°ç„": "Commute struggles: crowded train, traffic jam, running late, sleepy morning, packed subway, road rage",
  "ã€æ—¥å¸¸ã€‘æ—©èµ·å›°é›£": "Morning struggles: alarm clock, snooze button, zombie mode, need coffee, breakfast rush, late panic",
  "ã€æ—¥å¸¸ã€‘ç¡å‰æ™‚å…‰": "Bedtime routine: scrolling phone, can't sleep, counting sheep, sweet dreams, goodnight messages",
  
  // === æƒ…æ„Ÿé—œä¿‚é¡ ===
  "ã€æƒ…æ„Ÿã€‘æƒ…ä¾¶æ”¾é–ƒ": "Romantic couple: hugging, kissing, missing you, heart eyes, sweet moments, dating, love expressions",
  "ã€æƒ…æ„Ÿã€‘å–®èº«ç‹—": "Single life: forever alone, eating solo, third wheel, watching couples, self-love, independence",
  "ã€æƒ…æ„Ÿã€‘å¥½å‹äº’å—†": "Friend banter: sarcastic jokes, teasing, playful insults, savage comebacks, inside jokes",
  "ã€æƒ…æ„Ÿã€‘å®¶åº­æº«é¦¨": "Family warmth: family dinner, parents nagging, sibling fights, grandparents' love, family reunion",
  "ã€æƒ…æ„Ÿã€‘æš—æˆ€å¿ƒæƒ…": "Secret crush: blushing, nervous, shy glances, heart pounding, daydreaming, confessing feelings",
  "ã€æƒ…æ„Ÿã€‘åˆ†æ‰‹ç™‚å‚·": "Breakup healing: crying, ice cream therapy, moving on, heartbroken, new beginning, self-care",
  "ã€æƒ…æ„Ÿã€‘é–¨èœœæ™‚å…‰": "Besties time: girl talk, shopping together, secrets sharing, supporting each other, squad goals",
  "ã€æƒ…æ„Ÿã€‘å…„å¼Ÿæƒ…èª¼": "Brotherhood: bro fist, gaming together, having each other's back, loyalty, friendship goals",
  
  // === èˆˆè¶£æ„›å¥½é¡ ===
  "ã€èˆˆè¶£ã€‘ç¾é£Ÿåƒè²¨": "Foodie life: drooling, eating big meals, bubble tea, hungry, satisfied, food coma, midnight snack",
  "ã€èˆˆè¶£ã€‘é‹å‹•å¥èº«": "Fitness: gym workout, running, yoga, sweating, muscle soreness, protein shake, motivation",
  "ã€èˆˆè¶£ã€‘è²“å¥´æ—¥å¸¸": "Cat lover: playing with cats, feeding, litter cleaning, being ignored, cat ears, paws, meow",
  "ã€èˆˆè¶£ã€‘ç‹—æ´¾ç”Ÿæ´»": "Dog lover: walking dog, playing fetch, tail wagging, puppy eyes, loyal companion, woof",
  "ã€èˆˆè¶£ã€‘éŠæˆ²ç©å®¶": "Gamer: playing games, rage quit, victory, defeat, grinding, loot, GG, one more game",
  "ã€èˆˆè¶£ã€‘è¿½åŠ‡ç‹‚é­”": "Binge watching: Netflix marathon, one more episode, spoiler alert, plot twist, can't stop",
  "ã€èˆˆè¶£ã€‘è³¼ç‰©ç‹‚": "Shopaholic: online shopping, delivery, broke but happy, shopping spree, retail therapy",
  "ã€èˆˆè¶£ã€‘é–±è®€æ›¸èŸ²": "Bookworm: reading novels, library time, book recommendations, plot discussions, page turner",
  "ã€èˆˆè¶£ã€‘éŸ³æ¨‚è¿·": "Music lover: headphones on, concert vibes, singing along, playlist mood, rhythm feeling",
  "ã€èˆˆè¶£ã€‘æ”å½±æ„›å¥½": "Photography: taking photos, perfect angle, editing pics, camera gear, capturing moments",
  "ã€èˆˆè¶£ã€‘æ‰‹ä½œDIY": "Crafting: handmade items, creative projects, DIY fun, artistic expression, making things",
  "ã€èˆˆè¶£ã€‘åœ’è—ç¨®æ¤": "Gardening: planting seeds, watering plants, green thumb, harvest joy, nature connection",
  
  // === å­¸ç¿’å·¥ä½œé¡ ===
  "ã€å·¥ä½œã€‘æ ¡åœ’ç”Ÿæ´»": "School life: studying, exams, recess, homework, graduation, classroom, teacher, books",
  "ã€å·¥ä½œã€‘è€ƒè©¦åœ°ç„": "Exam hell: cramming, all-nighter, brain fog, test anxiety, blank mind, results day",
  "ã€å·¥ä½œã€‘æ–°æ‰‹çˆ¸åª½": "New parents: feeding baby, diaper changes, tired eyes, baby crying, family joy, parenting",
  "ã€å·¥ä½œã€‘å‰µæ¥­æ‰“æ‹¼": "Startup hustle: working late, pitching ideas, funding, pivot, burnout, success celebration",
  "ã€å·¥ä½œã€‘é è·å·¥ä½œ": "Remote work: home office, video calls, pajama meetings, work-life balance, digital nomad",
  "ã€å·¥ä½œã€‘è·å ´èœé³¥": "Workplace newbie: first day, learning ropes, asking questions, making mistakes, growing",
  "ã€å·¥ä½œã€‘å‡è·åŠ è–ª": "Career advancement: promotion, raise, achievement, recognition, career goals, success",
  "ã€å·¥ä½œã€‘æœƒè­°åœ°ç„": "Meeting overload: endless meetings, boring presentations, mute button, multitasking, finally done",
  
  // === æ—…éŠä¼‘é–’é¡ ===
  "ã€æ—…éŠã€‘æ—¥æœ¬æ—…éŠ": "Japan travel: sightseeing, ramen, hot springs, kimono, photos, shopping, tourist excitement",
  "ã€æ—…éŠã€‘æ­æ´²ä¹‹æ—…": "Europe travel: Eiffel Tower, museums, wine, backpacking, getting lost, beautiful scenery",
  "ã€æ—…éŠã€‘æµ·å³¶åº¦å‡": "Beach vacation: sunbathing, swimming, cocktails, sunset, relaxing, snorkeling, paradise",
  "ã€æ—…éŠã€‘éœ²ç‡Ÿé‡é¤": "Camping: tent setup, campfire, stargazing, hiking, nature, BBQ, outdoor adventure",
  "ã€æ—…éŠã€‘åŸå¸‚æ¢ç´¢": "City exploration: landmarks, street food, local culture, getting around, urban adventures",
  "ã€æ—…éŠã€‘å±±æ—å¥è¡Œ": "Mountain hiking: trekking, summit views, fresh air, challenging trails, nature beauty",
  "ã€æ—…éŠã€‘ç¾é£Ÿä¹‹æ—…": "Food tour: trying local dishes, street food, restaurants, culinary adventures, taste exploration",
  "ã€æ—…éŠã€‘æº«æ³‰ä¹‹æ—…": "Hot spring trip: relaxing bath, healing waters, spa time, rejuvenation, peaceful moments",
  
  // === ç¯€æ…¶ç‰¹æ®Šé¡ ===
  "ã€ç¯€æ…¶ã€‘ç¯€æ—¥æ…¶ç¥": "Festival celebration: birthday, New Year, Christmas, red envelopes, party, cake, fireworks",
  "ã€ç¯€æ…¶ã€‘è¬è–ç¯€": "Halloween: trick or treat, costumes, pumpkins, spooky, candy, haunted house, ghosts",
  "ã€ç¯€æ…¶ã€‘æƒ…äººç¯€": "Valentine's Day: roses, chocolates, romantic dinner, love letters, hearts, couple goals",
  "ã€ç¯€æ…¶ã€‘è¾²æ›†æ–°å¹´": "Lunar New Year: red envelopes, family reunion, dumplings, firecrackers, zodiac, prosperity",
  "ã€ç¯€æ…¶ã€‘ä¸­ç§‹ç¯€": "Mid-Autumn Festival: mooncakes, full moon, lanterns, family gathering, moon gazing",
  "ã€ç¯€æ…¶ã€‘ç«¯åˆç¯€": "Dragon Boat Festival: rice dumplings, dragon boats, traditional customs, festive atmosphere",
  "ã€ç¯€æ…¶ã€‘æ¯è¦ªç¯€": "Mother's Day: mom appreciation, flowers, gratitude, family love, special celebration",
  "ã€ç¯€æ…¶ã€‘ç•¢æ¥­å­£": "Graduation season: cap toss, diploma, farewell, new beginning, achievement, memories",
  
  // === ç¶²è·¯æ–‡åŒ–é¡ ===
  "ã€ç¶²è·¯ã€‘ç¶²è·¯ç”¨èª": "Internet slang: LOL, OMG, facepalm, trending memes, keyboard warrior, like & subscribe",
  "ã€ç¶²è·¯ã€‘è¿·å› æ¢—åœ–": "Meme culture: funny poses, viral references, sarcastic humor, troll vibes, internet jokes",
  "ã€ç¶²è·¯ã€‘ç›´æ’­ä¸»": "Streamer life: going live, chat interaction, donations, subscribers, viral moments",
  "ã€ç¶²è·¯ã€‘ç¤¾ç¾¤åª’é«”": "Social media: selfie, posting, likes, followers, influencer, hashtags, viral content",
  "ã€ç¶²è·¯ã€‘ç·šä¸ŠéŠæˆ²": "Online gaming: multiplayer, team play, voice chat, ranking up, gaming community",
  "ã€ç¶²è·¯ã€‘ç¶²è³¼é”äºº": "Online shopping pro: comparing prices, reading reviews, cart filling, package tracking",
  "ã€ç¶²è·¯ã€‘æ•¸ä½ç”Ÿæ´»": "Digital lifestyle: apps, notifications, screen time, tech savvy, connected world",
  "ã€ç¶²è·¯ã€‘è¡¨æƒ…åŒ…": "Emoji culture: expressive faces, reaction images, chat stickers, digital communication",
  
  // === æƒ…ç·’å¿ƒç†é¡ ===
  "ã€æƒ…ç·’ã€‘æ­£èƒ½é‡": "Positive vibes: fighting spirit, you can do it, good morning, thumbs up, motivation, cheer up",
  "ã€æƒ…ç·’ã€‘è² èƒ½é‡": "Negative energy: depression, dark cloud, soul leaving, giving up, exhausted, drained",
  "ã€æƒ…ç·’ã€‘ç„¦æ…®äººç”Ÿ": "Anxiety: overthinking, panic, stress, worried, nervous breakdown, need therapy",
  "ã€æƒ…ç·’ã€‘ä½›ç³»äººç”Ÿ": "Zen life: whatever, don't care, go with flow, inner peace, meditation, letting go",
  "ã€æƒ…ç·’ã€‘ç¤¾ææ—¥å¸¸": "Social anxiety: avoiding people, awkward moments, introvert struggles, comfort zone",
  "ã€æƒ…ç·’ã€‘æ‹–å»¶ç—‡": "Procrastination: deadline panic, last minute rush, I'll do it later, time management fails",
  "ã€æƒ…ç·’ã€‘å®Œç¾ä¸»ç¾©": "Perfectionism: attention to detail, high standards, never satisfied, striving for excellence",
  "ã€æƒ…ç·’ã€‘ç™‚ç™’æ™‚å…‰": "Healing moments: self-care, relaxation, peaceful vibes, comfort, soothing activities",
  
  // === è·æ¥­å°ˆæ¥­é¡ ===
  "ã€è·æ¥­ã€‘é†«è­·äººå“¡": "Healthcare workers: doctor, nurse, caring for patients, medical procedures, saving lives",
  "ã€è·æ¥­ã€‘è€å¸«æ•™è‚²": "Teachers: teaching, grading, classroom management, student interaction, education passion",
  "ã€è·æ¥­ã€‘è¨­è¨ˆå¸«": "Designers: creative work, brainstorming, design tools, client feedback, artistic vision",
  "ã€è·æ¥­ã€‘å·¥ç¨‹å¸«": "Engineers: coding, debugging, problem solving, technical work, innovation",
  "ã€è·æ¥­ã€‘æœå‹™æ¥­": "Service industry: customer service, hospitality, dealing with customers, service with smile",
  "ã€è·æ¥­ã€‘è—è¡“å®¶": "Artists: creating art, inspiration, exhibitions, artistic expression, creative process",
  
  // === å­£ç¯€å¤©æ°£é¡ ===
  "ã€å­£ç¯€ã€‘æ˜¥å¤©è³èŠ±": "Spring: cherry blossoms, flowers blooming, fresh start, pleasant weather, outdoor activities",
  "ã€å­£ç¯€ã€‘å¤æ—¥ç‚ç‚": "Summer: hot weather, beach time, ice cream, air conditioning, summer vacation",
  "ã€å­£ç¯€ã€‘ç§‹å¤©æ¥“è‘‰": "Autumn: falling leaves, cozy sweaters, harvest season, comfortable temperature, warm colors",
  "ã€å­£ç¯€ã€‘å†¬æ—¥é›ªæ™¯": "Winter: snow, cold weather, hot drinks, cozy indoors, winter activities, staying warm",
  "ã€å­£ç¯€ã€‘ä¸‹é›¨å¤©": "Rainy days: umbrella, staying dry, cozy indoors, rain sounds, puddle jumping",
  "ã€å­£ç¯€ã€‘é¢±é¢¨å¤©": "Typhoon day: strong winds, heavy rain, staying safe indoors, storm warnings, weather alert"
};

const STYLE_PROMPTS = {
  // === äºæ´²é¢¨æ ¼ ===
  "ã€äºæ´²ã€‘æ—¥å¼å‹•æ¼«": "Japanese anime style, light novel illustration, vibrant colors, cel shading, high-gloss, glowing effects, bloom, rim lighting",
  "ã€äºæ´²ã€‘å°‘å¥³æ¼«ç•«": "Shoujo manga: sparkles, flowers, big expressive eyes, soft pastels, romantic atmosphere, delicate linework",
  "ã€äºæ´²ã€‘å°‘å¹´æ¼«ç•«": "Shounen manga: dynamic action, speed lines, bold inking, energetic composition, intense expressions",
  "ã€äºæ´²ã€‘éŸ“å¼æ¼«ç•«": "Korean webtoon, manhwa: high quality, smooth coloring, clean lineart, volumetric lighting, pastel colors",
  "ã€äºæ´²ã€‘ä¸­å¼æ°´å¢¨": "Chinese ink painting: brush strokes, ink wash, flowing ink, calligraphy, watercolor, rice paper texture",
  "ã€äºæ´²ã€‘ä¸­å¼åœ‹é¢¨": "Chinese traditional style: classical aesthetics, elegant patterns, cultural elements, heritage design",
  "ã€äºæ´²ã€‘æ—¥å¼æµ®ä¸–ç¹ª": "Ukiyo-e style: woodblock print aesthetic, bold outlines, flat colors, traditional Japanese art",
  "ã€äºæ´²ã€‘æ³°å¼è—è¡“": "Thai art style: intricate patterns, gold details, temple aesthetics, Southeast Asian culture",
  
  // === è¥¿æ–¹é¢¨æ ¼ ===
  "ã€è¥¿æ–¹ã€‘ç¾å¼æ¼«ç•«": "American comic: bold outlines, heavy inking, cross-hatching, high contrast, vibrant colors, halftone dots",
  "ã€è¥¿æ–¹ã€‘æ­æ´²æ¼«ç•«": "European comic: ligne claire, Tintin style, clean lines, flat colors, detailed backgrounds",
  "ã€è¥¿æ–¹ã€‘è¿ªå£«å°¼": "Disney animation: Pixar style, stylized 3D, polished, expressive characters, soft shapes, warm colors",
  "ã€è¥¿æ–¹ã€‘å‰åœåŠ›": "Studio Ghibli: hand-drawn animation, watercolor backgrounds, nostalgic, whimsical, nature elements",
  "ã€è¥¿æ–¹ã€‘å¤¢å·¥å» ": "DreamWorks animation: expressive faces, dynamic poses, vibrant colors, modern 3D, comedic",
  "ã€è¥¿æ–¹ã€‘å¡é€šç¶²çµ¡": "Cartoon Network style: bold shapes, exaggerated features, quirky characters, fun aesthetics",
  
  // === å¯«å¯¦é¢¨æ ¼ ===
  "ã€å¯«å¯¦ã€‘ç…§ç‰‡å¯«å¯¦": "Photorealistic: hyperrealistic, cinematic lighting, detailed textures, natural colors, 8k quality",
  "ã€å¯«å¯¦ã€‘é›»å½±è³ªæ„Ÿ": "Cinematic: movie poster style, dramatic lighting, film grain, lens flare, color grading",
  "ã€å¯«å¯¦ã€‘æ²¹ç•«è³ªæ„Ÿ": "Oil painting: thick brush strokes, impasto, rich colors, textured canvas, classical art",
  "ã€å¯«å¯¦ã€‘æ°´å½©ç•«": "Watercolor: soft washes, transparent layers, flowing colors, paper texture, artistic fluidity",
  "ã€å¯«å¯¦ã€‘ç´ æé‰›ç­†": "Pencil sketch: graphite drawing, shading, hatching, realistic proportions, detailed linework",
  "ã€å¯«å¯¦ã€‘ç‚­ç­†ç•«": "Charcoal drawing: bold strokes, dramatic contrast, smudged shading, expressive marks",
  
  // === å¯æ„›é¢¨æ ¼ ===
  "ã€å¯æ„›ã€‘Qç‰ˆèŒç³»": "Chibi style: super deformed, large heads, small bodies, thick lines, soft colors, kawaii",
  "ã€å¯æ„›ã€‘ä¸‰éº—é·—": "Sanrio style: Hello Kitty aesthetic, extremely cute, pastel rainbow, simple shapes, adorable",
  "ã€å¯æ„›ã€‘è»ŸèŒé¢¨": "Soft fluffy: marshmallow aesthetic, gentle gradients, rounded shapes, baby colors, cozy",
  "ã€å¯æ„›ã€‘å¡å“‡ä¼Š": "Kawaii culture: Japanese cute, pastel colors, sparkles, hearts, adorable expressions",
  "ã€å¯æ„›ã€‘å¸ƒå¶ç©å…·": "Plushie style: soft toy aesthetic, stitching details, cuddly appearance, fabric texture",
  "ã€å¯æ„›ã€‘ç³–æœè‰²": "Candy colors: sweet pastels, sugary aesthetic, bright cheerful, dessert inspired",
  
  // === å¾©å¤é¢¨æ ¼ ===
  "ã€å¾©å¤ã€‘åƒç´ è—è¡“": "Pixel art: 8-bit, 16-bit retro game, low resolution, dot art, visible grid, dithering",
  "ã€å¾©å¤ã€‘80å¹´ä»£": "1980s retro: neon colors, synthwave, geometric shapes, bold outlines, arcade vibes",
  "ã€å¾©å¤ã€‘90å¹´ä»£": "1990s anime: retro aesthetic, VHS quality, nostalgic colors, classic cel animation",
  "ã€å¾©å¤ã€‘å¾©å¤å¡é€š": "Vintage cartoon: 1930s rubber hose, black and white, grainy film, classic animation",
  "ã€å¾©å¤ã€‘è’¸æ°£é¾å…‹": "Steampunk: Victorian era, brass gears, mechanical, industrial, vintage futuristic",
  "ã€å¾©å¤ã€‘è€é›»å½±": "Old film: sepia tone, film grain, vintage cinematography, classic movie aesthetic",
  
  // === ç¾ä»£æ•¸ä½ ===
  "ã€ç¾ä»£ã€‘3Dæ¸²æŸ“": "3D render: CGI, detailed models, realistic textures, PBR, octane render, volumetric lighting",
  "ã€ç¾ä»£ã€‘æ‰å¹³åŒ–": "Flat design: minimal, solid colors, no gradients, geometric shapes, modern UI, vector art",
  "ã€ç¾ä»£ã€‘Material Design": "Google Material: depth and shadow, bold colors, grid layouts, responsive, modern digital",
  "ã€ç¾ä»£ã€‘è³½åšé¾å…‹": "Cyberpunk: neon lights, futuristic cityscape, high tech low life, holographic, sci-fi",
  "ã€ç¾ä»£ã€‘æœªä¾†ç§‘æŠ€": "Futuristic tech: sleek design, holographic interfaces, advanced technology, sci-fi elements",
  "ã€ç¾ä»£ã€‘æ¥µç°¡ä¸»ç¾©": "Minimalism: simple clean, negative space, essential elements only, modern aesthetics",
  "ã€ç¾ä»£ã€‘éœ“è™¹ç‡ˆå…‰": "Neon glow: glowing lights, vibrant neon, dark background, nightlife aesthetic, luminous",
  
  // === è—è¡“æµæ´¾ ===
  "ã€è—è¡“ã€‘æ³¢æ™®è—è¡“": "Pop Art: Andy Warhol inspired, bold colors, Ben-Day dots, comic aesthetic, mass culture",
  "ã€è—è¡“ã€‘æŠ½è±¡è—è¡“": "Abstract art: geometric shapes, bold colors, non-representational, modern art, expressive",
  "ã€è—è¡“ã€‘å¡—é´‰è—è¡“": "Graffiti: street art, spray paint, urban culture, bold letters, vibrant, hip-hop",
  "ã€è—è¡“ã€‘å‰ªç´™è—è¡“": "Paper cut: layered paper, shadow box, silhouette design, folk art, handcrafted",
  "ã€è—è¡“ã€‘å°è±¡æ´¾": "Impressionism: visible brush strokes, light emphasis, ordinary subject matter, movement",
  "ã€è—è¡“ã€‘è¶…ç¾å¯¦": "Surrealism: dreamlike, bizarre imagery, unexpected juxtapositions, subconscious exploration",
  "ã€è—è¡“ã€‘è¡¨ç¾ä¸»ç¾©": "Expressionism: emotional intensity, distorted forms, vivid colors, subjective perspective",
  
  // === ç‰¹æ®Šæè³ª ===
  "ã€æè³ªã€‘æ¯›æ°ˆå¸ƒè—": "Felt fabric: soft textile, handmade craft, stitching, cozy material, warm texture",
  "ã€æè³ªã€‘é»åœŸé™¶è—": "Clay sculpture: handmade pottery, ceramic texture, sculpted forms, artisan craft",
  "ã€æè³ªã€‘ç»ç’ƒå·¥è—": "Glass art: transparent, reflective, colorful glass, light refraction, delicate",
  "ã€æè³ªã€‘é‡‘å±¬è³ªæ„Ÿ": "Metallic: shiny metal, reflective surface, industrial, chrome, steel texture",
  "ã€æè³ªã€‘æœ¨è³ªç´‹ç†": "Wood texture: natural grain, warm tones, organic material, rustic, handcrafted",
  "ã€æè³ªã€‘ç´™å¼µæ‹¼è²¼": "Paper collage: cut and paste, layered paper, mixed media, textured composition",
  
  // === ç‰¹æ®Šæ•ˆæœ ===
  "ã€æ•ˆæœã€‘ç™¼å…‰æ•ˆæœ": "Glowing: luminous, light emission, radiant, bright aura, magical glow",
  "ã€æ•ˆæœã€‘æ°´æ™¶é€æ˜": "Crystal clear: transparent, glass-like, refractive, sparkling, pristine",
  "ã€æ•ˆæœã€‘æ¯›çµ¨è³ªæ„Ÿ": "Fluffy fur: soft texture, fuzzy, plush, cozy, warm and cuddly",
  "ã€æ•ˆæœã€‘æ¶²é«”æµå‹•": "Liquid flow: fluid dynamics, flowing water, melting, dripping, dynamic movement",
  "ã€æ•ˆæœã€‘ç…™éœ§è¿·å¹»": "Smoke and mist: ethereal, foggy, mysterious atmosphere, soft diffusion",
  "ã€æ•ˆæœã€‘ç«ç„°ç‡ƒç‡’": "Fire and flames: burning, heat, dynamic energy, warm glow, intense"
};

const FONT_STYLES = {
  // === åŸºç¤å­—é«” ===
  "ã€åŸºç¤ã€‘é»‘é«”": "Bold Sans-serif, Heiti, modern, clean, high legibility, standard font",
  "ã€åŸºç¤ã€‘åœ“é«”": "Rounded Sans-serif, YuanTi, soft edges, cute, friendly, kawaii typography",
  "ã€åŸºç¤ã€‘æ˜é«”": "Serif font, Mincho, elegant, traditional, formal, classic, readable",
  "ã€åŸºç¤ã€‘æ¥·é«”": "Kai font, regular script, balanced, standard Chinese calligraphy style",
  
  // === æ‰‹å¯«ç³»åˆ— ===
  "ã€æ‰‹å¯«ã€‘æ‰‹å¯«é«”": "Handwritten, marker pen, casual, personal, messy but cute, notebook doodle",
  "ã€æ‰‹å¯«ã€‘é‹¼ç­†å­—": "Fountain pen calligraphy, flowing strokes, elegant handwriting, cursive, sophisticated",
  "ã€æ‰‹å¯«ã€‘ç²‰ç­†å­—": "Chalk font, blackboard style, rough texture, educational vibe, handwritten chalk",
  "ã€æ‰‹å¯«ã€‘è Ÿç­†å­—": "Crayon font, child-like writing, colorful strokes, playful, kindergarten aesthetic",
  "ã€æ‰‹å¯«ã€‘ç°½åå­—": "Signature style, personal autograph, flowing script, unique character, artistic",
  "ã€æ‰‹å¯«ã€‘å¡—é´‰å­—": "Doodle font, casual sketching, playful marks, informal, creative scribbles",
  
  // === æ›¸æ³•è—è¡“ ===
  "ã€æ›¸æ³•ã€‘æ›¸æ³•é«”": "Chinese Calligraphy, brush strokes, energetic, traditional ink, powerful lines",
  "ã€æ›¸æ³•ã€‘è¡Œæ›¸": "Running script, semi-cursive, flowing characters, artistic calligraphy, dynamic",
  "ã€æ›¸æ³•ã€‘ç¯†æ›¸": "Seal script, ancient Chinese characters, decorative, traditional, historical",
  "ã€æ›¸æ³•ã€‘è‰æ›¸": "Cursive script, highly stylized, flowing, artistic, expressive brush work",
  "ã€æ›¸æ³•ã€‘éš¸æ›¸": "Clerical script, flat and wide, ancient style, formal, historical Chinese",
  
  // === ç¾ä»£è¨­è¨ˆ ===
  "ã€ç¾ä»£ã€‘POPé«”": "POP art style, bold bubble letters, heavy outlines, advertisement, vivid and bouncy",
  "ã€ç¾ä»£ã€‘ç¶œè—é«”": "Variety show subtitle, extra bold, exaggerated strokes, attention-grabbing, TV font",
  "ã€ç¾ä»£ã€‘éœ“è™¹å­—": "Neon sign font, glowing effect, retro futuristic, bright colors, nightlife aesthetic",
  "ã€ç¾ä»£ã€‘ç«‹é«”å­—": "3D font, extruded letters, shadow and depth, dimensional typography, bold presence",
  "ã€ç¾ä»£ã€‘ç§‘æŠ€å­—": "Tech font, futuristic, digital display, sci-fi style, modern technology, sleek",
  "ã€ç¾ä»£ã€‘å¹¾ä½•å­—": "Geometric font, angular shapes, modern design, structured, architectural",
  
  // === å¯æ„›ç³»åˆ— ===
  "ã€å¯æ„›ã€‘å¨ƒå¨ƒé«”": "Childish font, crayon style, playful, naive, irregular sizes, kindergarten",
  "ã€å¯æ„›ã€‘æ³¡æ³¡å­—": "Bubble font, rounded bubbly letters, soft and bouncy, cute and friendly, cartoon",
  "ã€å¯æ„›ã€‘æ£‰èŠ±ç³–é«”": "Marshmallow font, super soft and fluffy, pastel aesthetic, sweet and gentle, kawaii",
  "ã€å¯æ„›ã€‘å¡é€šå­—": "Cartoon font, playful, exaggerated, fun, animated style, child-friendly",
  "ã€å¯æ„›ã€‘è²“å’ªå­—": "Cat-themed font, paw prints, whiskers, cute animal elements, playful",
  
  // === å¾©å¤ç³»åˆ— ===
  "ã€å¾©å¤ã€‘åƒç´ é«”": "Pixel font, 8-bit, retro gaming style, blocky, jagged edges, digital look",
  "ã€å¾©å¤ã€‘æ‰“å­—æ©Ÿ": "Typewriter font, monospaced, vintage mechanical, retro office, classic typing",
  "ã€å¾©å¤ã€‘å ±ç´™é«”": "Newspaper headline font, bold serif, press style, editorial typography, classic news",
  "ã€å¾©å¤ã€‘è€é›»å½±": "Vintage cinema font, classic movie titles, retro Hollywood, film credits",
  "ã€å¾©å¤ã€‘è¥¿éƒ¨ç‰›ä»”": "Western font, wild west style, rustic, saloon aesthetic, frontier typography",
  
  // === ç‰¹æ®Šé¢¨æ ¼ ===
  "ã€ç‰¹æ®Šã€‘æ¼«ç•«å­—": "Comic book font, action words, sound effects, dynamic, energetic, POW BAM style",
  "ã€ç‰¹æ®Šã€‘ææ€–å­—": "Horror font, dripping letters, creepy style, Halloween vibe, scary typography",
  "ã€ç‰¹æ®Šã€‘å¡—é´‰å­—": "Graffiti font, street art style, urban culture, spray paint effect, hip-hop",
  "ã€ç‰¹æ®Šã€‘å“¥å¾·å­—": "Gothic font, medieval style, ornate, blackletter, dramatic, historical",
  "ã€ç‰¹æ®Šã€‘æ­¦ä¿ å­—": "Martial arts font, Chinese sword fighting aesthetic, heroic, traditional",
  "ã€ç‰¹æ®Šã€‘é­”æ³•å­—": "Magical font, mystical, fantasy style, enchanted, spellbook aesthetic",
  
  // === è£é£¾æ•ˆæœ ===
  "ã€è£é£¾ã€‘æé‚Šå­—": "Outlined font, thick stroke borders, high contrast, clear definition, bold presence",
  "ã€è£é£¾ã€‘é™°å½±å­—": "Shadow font, drop shadow effect, depth, dimensional, layered appearance",
  "ã€è£é£¾ã€‘æ¼¸å±¤å­—": "Gradient font, color transition, rainbow effect, vibrant, eye-catching",
  "ã€è£é£¾ã€‘ç™¼å…‰å­—": "Glowing font, luminous effect, neon glow, radiant, bright aura",
  "ã€è£é£¾ã€‘é‡‘å±¬å­—": "Metallic font, chrome effect, shiny, reflective, luxurious appearance",
  "ã€è£é£¾ã€‘ç«ç„°å­—": "Flame font, burning effect, fiery, dynamic, intense energy"
};

    let STICKER_CONFIG = {
      COLS: 4,
      ROWS: 4,
      CELL_WIDTH: 370,
      CELL_HEIGHT: 320
    };

    // State
    let apiKey = localStorage.getItem('gemini_api_key') || '';
    let uploadedImage = null;
    let generatedImage = null;
    let stickers = [];
    let loading = false;

    // Initialize
    function init() {
      // Populate selects
      const themeSelect = document.getElementById('themeSelect');
      Object.keys(THEME_PROMPTS).forEach(theme => {
        const option = document.createElement('option');
        option.value = theme;
        option.textContent = theme;
        themeSelect.appendChild(option);
      });

      const styleSelect = document.getElementById('styleSelect');
      Object.keys(STYLE_PROMPTS).forEach(style => {
        const option = document.createElement('option');
        option.value = style;
        option.textContent = style;
        styleSelect.appendChild(option);
      });

      const fontSelect = document.getElementById('fontSelect');
      Object.keys(FONT_STYLES).forEach(font => {
        const option = document.createElement('option');
        option.value = font;
        option.textContent = font;
        fontSelect.appendChild(option);
      });

      // Event listeners
      document.getElementById('uploadArea').addEventListener('click', () => {
        document.getElementById('fileInput').click();
      });

      document.getElementById('fileInput').addEventListener('change', handleFileUpload);

      document.getElementById('borderWidth').addEventListener('input', (e) => {
        document.getElementById('borderValue').textContent = e.target.value;
      });

      // Grid config change
      document.getElementById('gridConfig').addEventListener('change', (e) => {
        const value = e.target.value;
        const [cols, rows] = value.split('x').map(Number);
        STICKER_CONFIG.COLS = cols;
        STICKER_CONFIG.ROWS = rows;
      });

      // Drag and drop
      const uploadArea = document.getElementById('uploadArea');
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--primary)';
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.style.borderColor = '#d1d5db';
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#d1d5db';
        const file = e.dataTransfer.files[0];
        if (file && (file.type === 'image/png' || file.type === 'image/jpeg')) {
          handleFile(file);
        }
      });
    }

    function handleFileUpload(e) {
      const file = e.target.files[0];
      if (file) {
        handleFile(file);
      }
    }

    function handleFile(file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        uploadedImage = event.target.result;
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.innerHTML = `<img src="${uploadedImage}" alt="Uploaded">`;
        
        // Reset
        generatedImage = null;
        stickers = [];
        document.getElementById('generatedCard').style.display = 'none';
        document.getElementById('stickersCard').style.display = 'none';
      };
      reader.readAsDataURL(file);
    }



    function showApiKeyModal() {
      document.getElementById('apiKeyModal').classList.add('show');
      document.getElementById('apiKeyInput').value = apiKey;
    }

    function showTutorialModal() {
      document.getElementById('tutorialModal').classList.add('show');
    }

    function closeTutorialModal() {
      document.getElementById('tutorialModal').classList.remove('show');
    }

    function saveApiKey() {
      apiKey = document.getElementById('apiKeyInput').value;
      if (apiKey) {
        localStorage.setItem('gemini_api_key', apiKey);
        document.getElementById('apiKeyModal').classList.remove('show');
        alert('âœ… API Keyå·²ä¿å­˜æˆåŠŸï¼');
      } else {
        alert('âš ï¸ è«‹è¼¸å…¥API Key');
      }
    }

    async function handleGenerate() {
      if (!apiKey) {
        showApiKeyModal();
        return;
      }

      if (!uploadedImage) {
        alert('âš ï¸ è«‹å…ˆä¸Šå‚³ä¸€å¼µè§’è‰²åœ–ç‰‡ï¼');
        return;
      }

      loading = true;
      showProgress('ğŸ¨ æ­£åœ¨å‘¼å«AIè¨­è¨ˆå¸«ç”Ÿæˆè²¼åœ–...', 10);
      const btn = document.getElementById('generateBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>ç”Ÿæˆä¸­...';

      try {
        const theme = document.getElementById('themeSelect').value;
        const style = document.getElementById('styleSelect').value;
        const font = document.getElementById('fontSelect').value;
        const textSize = document.getElementById('textSize').value;

        const MODEL_NAME = "gemini-3-pro-image-preview";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;

        const base64Image = uploadedImage.split(',')[1];
        const themeDescription = THEME_PROMPTS[theme];
        const styleDescription = STYLE_PROMPTS[style];
        const fontDescription = FONT_STYLES[font];

        // æ·»åŠ éš¨æ©Ÿç¨®å­ç¢ºä¿æ¯æ¬¡ç”Ÿæˆä¸åŒ
        const randomSeed = Math.floor(Math.random() * 1000000);
        const timestamp = Date.now();
        
        const totalStickers = STICKER_CONFIG.COLS * STICKER_CONFIG.ROWS;
        
        const targetWidth = STICKER_CONFIG.CELL_WIDTH * STICKER_CONFIG.COLS;
        const targetHeight = STICKER_CONFIG.CELL_HEIGHT * STICKER_CONFIG.ROWS;
        
        const promptText = `
You MUST create EXACTLY a ${STICKER_CONFIG.COLS} Ã— ${STICKER_CONFIG.ROWS} grid (${totalStickers} total stickers).

Image Dimensions: EXACTLY ${targetWidth}px width Ã— ${targetHeight}px height.

[Generation ID: ${randomSeed}-${timestamp}]

âš ï¸ CRITICAL GRID REQUIREMENTS (DO NOT DEVIATE):
- Grid Layout: EXACTLY ${STICKER_CONFIG.COLS} columns Ã— ${STICKER_CONFIG.ROWS} rows = ${totalStickers} stickers
- Cell Size: Each cell is EXACTLY ${STICKER_CONFIG.CELL_WIDTH}px Ã— ${STICKER_CONFIG.CELL_HEIGHT}px
- Grid Precision: Perfect alignment with NO gaps, NO overlaps, NO extra spacing
- Cell Boundaries: Each sticker must fit EXACTLY within its cell boundaries
- Mathematical Check: Total width = ${STICKER_CONFIG.COLS} Ã— ${STICKER_CONFIG.CELL_WIDTH} = ${targetWidth}px, Total height = ${STICKER_CONFIG.ROWS} Ã— ${STICKER_CONFIG.CELL_HEIGHT} = ${targetHeight}px
- NO extra rows, NO extra columns, NO partial cells

Content Requirements:
1. Character: Based on the input image provided
2. Theme: "${themeDescription}"
3. Text Requirements (CRITICAL - NO DUPLICATES ALLOWED):
   - Traditional Chinese (ç¹é«”ä¸­æ–‡) ONLY with 2-3px WHITE OUTLINE
   - âš ï¸ ABSOLUTELY NO DUPLICATE TEXT - Every single sticker MUST have UNIQUE, DIFFERENT text
   - Check before finalizing: NO two stickers should have the same text
   - Match text to expression/emotion naturally
   - Use varied colloquial phrases (e.g., "å¥½ç´¯å–”", "å¤ªé–‹å¿ƒäº†", "ä¸è¦å•Š", "åŠ æ²¹", "ç¡è¦ºå»", "åƒé£¯äº†")
   - NO Simplified Chinese, NO English, NO random text
4. Typography Style: "${fontDescription}"
   - Colors: bright orange, hot pink, cyan, red, purple
   - ABSOLUTELY NO GREEN (will be removed by chroma key)
   - Text Size: ${textSize === 'small' ? '24-32px (small, subtle text)' : textSize === 'medium' ? '36-48px (medium, balanced text)' : textSize === 'large' ? '52-64px (large, prominent text)' : '68-80px (extra large, bold text)'} - Make text ${textSize === 'small' ? 'smaller and more subtle' : textSize === 'medium' ? 'medium-sized and balanced' : textSize === 'large' ? 'large and eye-catching' : 'extra large and very bold'}
5. Art Style: "${styleDescription}"
6. Background: Pure green (#00FF00) for entire canvas
7. Each sticker: UNIQUE poses, expressions, and text

Final Check Before Submission:
1. Count: EXACTLY ${totalStickers} stickers in ${STICKER_CONFIG.COLS} columns Ã— ${STICKER_CONFIG.ROWS} rows
2. Text Uniqueness: Verify NO duplicate text - all ${totalStickers} text phrases must be different
3. Grid Alignment: Perfect grid with equal spacing
        `;

        updateProgress(30);

        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{
              parts: [
                { text: promptText },
                {
                  inlineData: {
                    mimeType: "image/png",
                    data: base64Image
                  }
                }
              ]
            }],
            generationConfig: {
              responseModalities: ["TEXT", "IMAGE"],
              imageConfig: {
                imageSize: "2K"
              },
              temperature: 1.0,
              topK: 40,
              topP: 0.95,
              seed: randomSeed
            }
          })
        });

        if (!response.ok) {
          let errData;
          try {
            errData = await response.json();
          } catch (e) {
            errData = { error: { message: `HTTP ${response.status}: ${response.statusText}` } };
          }
          console.error('API Error:', errData);
          
          let errorMsg = 'APIè«‹æ±‚å¤±æ•—';
          if (response.status === 500) {
            errorMsg = 'Gemini APIå…§éƒ¨éŒ¯èª¤ï¼Œå¯èƒ½åŸå› ï¼š\n1. æç¤ºè©éé•·æˆ–åœ–ç‰‡éå¤§\n2. APIé…é¡ä¸è¶³\n3. æ¨¡å‹æš«æ™‚ä¸å¯ç”¨\n\nè«‹ç¨å¾Œå†è©¦æˆ–æ›´æ›è¼ƒå°çš„ç¶²æ ¼ï¼ˆ3x3ï¼‰';
          } else if (response.status === 429) {
            errorMsg = 'APIè«‹æ±‚éæ–¼é »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦';
          } else if (response.status === 400) {
            errorMsg = 'APIè«‹æ±‚åƒæ•¸éŒ¯èª¤ï¼š' + (errData.error?.message || 'è«‹æª¢æŸ¥API Keyæ˜¯å¦æ­£ç¢º');
          } else {
            errorMsg = errData.error?.message || errorMsg;
          }
          
          throw new Error(errorMsg);
        }

        const data = await response.json();
        console.log('API Response:', data);
        
        // è§£æGeminiè¿”å›çš„åœ–ç‰‡
        let foundImage = null;
        const candidates = data.candidates || [];
        
        for (const candidate of candidates) {
          if (candidate.content && candidate.content.parts) {
            for (const part of candidate.content.parts) {
              if (part.inlineData && part.inlineData.mimeType && part.inlineData.mimeType.startsWith('image')) {
                foundImage = `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                console.log('Found image in inlineData with mimeType:', part.inlineData.mimeType);
                break;
              }
              if (part.inline_data && part.inline_data.mime_type && part.inline_data.mime_type.startsWith('image')) {
                foundImage = `data:${part.inline_data.mime_type};base64,${part.inline_data.data}`;
                console.log('Found image in inline_data with mime_type:', part.inline_data.mime_type);
                break;
              }
            }
          }
          if (foundImage) break;
        }

        if (!foundImage) {
          console.error('No image found in response. Full response:', JSON.stringify(data, null, 2));
          throw new Error('æ¨¡å‹æ²’æœ‰ç”Ÿæˆåœ–ç‰‡,è«‹é‡è©¦ï¼ˆå¯èƒ½æ˜¯è¢«å®‰å…¨éæ¿¾æ””æˆªï¼‰');
        }
        
        generatedImage = foundImage;
        document.getElementById('generatedImage').src = generatedImage;
        document.getElementById('generatedCard').style.display = 'block';

        updateProgress(100);
        hideProgress();
        alert(`âœ… è²¼åœ–ç”ŸæˆæˆåŠŸï¼å…±${totalStickers}å¼µ`);
      } catch (error) {
        console.error('Generation Error:', error);
        alert('âŒ ç”Ÿæˆå¤±æ•—ï¼š' + error.message);
        hideProgress();
      } finally {
        loading = false;
        btn.disabled = false;
        btn.innerHTML = 'âœ¨ ç”Ÿæˆè²¼åœ–';
      }
    }

    async function handleProcess() {
      if (!generatedImage) {
        alert('âš ï¸ è«‹å…ˆç”Ÿæˆè²¼åœ–ï¼');
        return;
      }

      showProgress('ğŸ­ æ­£åœ¨å»èƒŒ...', 20);

      try {
        // 1. Remove green screen
        const removedBg = await removeGreenScreen(generatedImage);
        updateProgress(40);

        // 2. Crop stickers
        showProgress('âœ‚ï¸ æ­£åœ¨è£åˆ‡è²¼åœ–...', 40);
        const cropped = await cropStickers(removedBg);
        updateProgress(60);

        // 3. Add white border
        showProgress('ğŸ–¼ï¸ æ­£åœ¨æ·»åŠ ç™½é‚Š...', 60);
        const borderWidth = parseInt(document.getElementById('borderWidth').value);
        stickers = await addWhiteBorderBatch(cropped, borderWidth);
        updateProgress(80);

        // 4. Display stickers
        displayStickers();
        updateProgress(100);
        hideProgress();

        document.getElementById('stickersCard').style.display = 'block';
        const totalStickers = STICKER_CONFIG.COLS * STICKER_CONFIG.ROWS;
        alert(`âœ… è™•ç†å®Œæˆï¼å…±${totalStickers}å¼µè²¼åœ–`);
      } catch (error) {
        console.error('Processing Error:', error);
        alert('âŒ è™•ç†å¤±æ•—ï¼š' + error.message);
        hideProgress();
      }
    }

    function removeGreenScreen(imageUrl, threshold = 50) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);

          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;

          for (let i = 0; i < data.length; i += 4) {
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];

            if (g > r + threshold && g > b + threshold && g > 100) {
              data[i + 3] = 0;
            }
          }

          ctx.putImageData(imageData, 0, 0);
          resolve(canvas.toDataURL('image/png'));
        };

        img.onerror = () => reject(new Error('åœ–ç‰‡åŠ è¼‰å¤±æ•—'));
        img.src = imageUrl;
      });
    }

    function cropStickers(imageUrl) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        
        img.onload = () => {
          const { COLS, ROWS, CELL_WIDTH, CELL_HEIGHT } = STICKER_CONFIG;
          const stickers = [];
          
          const cellWidth = img.width / COLS;
          const cellHeight = img.height / ROWS;
          
          const margin = 0.02;

          for (let row = 0; row < ROWS; row++) {
            for (let col = 0; col < COLS; col++) {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');

              canvas.width = CELL_WIDTH;
              canvas.height = CELL_HEIGHT;

              const sx = cellWidth * col + (cellWidth * margin);
              const sy = cellHeight * row + (cellHeight * margin);
              const sw = cellWidth * (1 - margin * 2);
              const sh = cellHeight * (1 - margin * 2);

              ctx.drawImage(img, sx, sy, sw, sh, 0, 0, CELL_WIDTH, CELL_HEIGHT);
              stickers.push(canvas.toDataURL('image/png'));
            }
          }

          resolve(stickers);
        };

        img.onerror = () => reject(new Error('åœ–ç‰‡åŠ è¼‰å¤±æ•—'));
        img.src = imageUrl;
      });
    }

    function addWhiteBorder(imageUrl, borderWidth) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');

          canvas.width = img.width + borderWidth * 2;
          canvas.height = img.height + borderWidth * 2;
          
          if (borderWidth > 0) {
            for (let offsetY = -borderWidth; offsetY <= borderWidth; offsetY++) {
              for (let offsetX = -borderWidth; offsetX <= borderWidth; offsetX++) {
                const distance = Math.sqrt(offsetX * offsetX + offsetY * offsetY);
                if (distance <= borderWidth) {
                  ctx.globalAlpha = 1;
                  ctx.drawImage(img, borderWidth + offsetX, borderWidth + offsetY);
                }
              }
            }
            
            ctx.globalCompositeOperation = 'source-in';
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.globalCompositeOperation = 'source-over';
          }
          
          ctx.drawImage(img, borderWidth, borderWidth);

          resolve(canvas.toDataURL('image/png'));
        };

        img.onerror = () => reject(new Error('åœ–ç‰‡åŠ è¼‰å¤±æ•—'));
        img.src = imageUrl;
      });
    }

    async function addWhiteBorderBatch(imageUrls, borderWidth) {
      return Promise.all(imageUrls.map(url => addWhiteBorder(url, borderWidth)));
    }

    function displayStickers() {
      const grid = document.getElementById('stickerGrid');
      grid.innerHTML = '';
      
      // Update badge count
      document.getElementById('stickerCount').textContent = `${stickers.length}å¼µ`;
      
      // Update grid columns based on config
      grid.style.gridTemplateColumns = `repeat(${STICKER_CONFIG.COLS}, 1fr)`;

      stickers.forEach((sticker, index) => {
        const div = document.createElement('div');
        div.className = 'sticker-item';
        div.onclick = () => downloadImage(sticker, `LINE_sticker_${index + 1}.png`);
        
        const img = document.createElement('img');
        img.src = sticker;
        div.appendChild(img);
        
        grid.appendChild(div);
      });
    }

    function downloadImage(dataUrl, filename) {
      const link = document.createElement('a');
      link.href = dataUrl;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    async function downloadAllAsZip() {
      if (stickers.length === 0) {
        alert('âš ï¸ æ²’æœ‰å¯ä¸‹è¼‰çš„è²¼åœ–ï¼');
        return;
      }

      try {
        const zip = new JSZip();

        for (let i = 0; i < stickers.length; i++) {
          const base64Data = stickers[i].split(',')[1];
          zip.file(`LINE_sticker_${i + 1}.png`, base64Data, { base64: true });
        }

        const blob = await zip.generateAsync({ type: 'blob' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'LINE_stickers_' + Date.now() + '.zip';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);

        alert(`âœ… ä¸‹è¼‰æˆåŠŸï¼å…±${stickers.length}å¼µè²¼åœ–`);
      } catch (error) {
        alert('âŒ ä¸‹è¼‰å¤±æ•—ï¼š' + error.message);
        console.error(error);
      }
    }

    function showProgress(text, progress) {
      document.getElementById('progressCard').style.display = 'block';
      document.getElementById('statusText').textContent = text;
      document.getElementById('progressFill').style.width = progress + '%';
    }

    function updateProgress(progress) {
      document.getElementById('progressFill').style.width = progress + '%';
    }

    function hideProgress() {
      setTimeout(() => {
        document.getElementById('progressCard').style.display = 'none';
      }, 500);
    }

    // Close modal when clicking outside
    document.getElementById('apiKeyModal').addEventListener('click', (e) => {
      if (e.target.id === 'apiKeyModal') {
        document.getElementById('apiKeyModal').classList.remove('show');
      }
    });

    // Initialize on load
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
